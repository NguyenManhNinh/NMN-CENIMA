<?xml version="1.0" encoding="UTF-8"?>
<mxfile host="app.diagrams.net" modified="2026-01-07T02:21:00.000Z" agent="Claude" version="21.0.0" type="device">
  <diagram name="PaymentSequence" id="payment-seq"><mxGraphModel dx="1200" dy="900" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1200" pageHeight="1000" math="0" shadow="0"><root><mxCell id="0" /><mxCell id="1" parent="0" />
        <!-- Participants -->
        <mxCell id="user" value="User" style="shape=umlActor;verticalLabelPosition=bottom;verticalAlign=top;html=1;outlineConnect=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="50" y="40" width="30" height="60" as="geometry" />
        </mxCell>
        <mxCell id="fe" value=":PaymentConfirmPage" style="shape=umlLifeline;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=1;collapsible=0;recursiveResize=0;outlineConnect=0;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="140" y="40" width="130" height="850" as="geometry" />
        </mxCell>
        <mxCell id="va" value=":voucherApi" style="shape=umlLifeline;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=1;collapsible=0;recursiveResize=0;outlineConnect=0;fillColor=#e1d5e7;strokeColor=#9673a6;" vertex="1" parent="1">
          <mxGeometry x="310" y="40" width="90" height="850" as="geometry" />
        </mxCell>
        <mxCell id="oa" value=":orderApi" style="shape=umlLifeline;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=1;collapsible=0;recursiveResize=0;outlineConnect=0;fillColor=#e1d5e7;strokeColor=#9673a6;" vertex="1" parent="1">
          <mxGeometry x="440" y="40" width="80" height="850" as="geometry" />
        </mxCell>
        <mxCell id="be" value=":Backend" style="shape=umlLifeline;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=1;collapsible=0;recursiveResize=0;outlineConnect=0;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="560" y="40" width="90" height="850" as="geometry" />
        </mxCell>
        <mxCell id="db" value=":MongoDB" style="shape=umlLifeline;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=1;collapsible=0;recursiveResize=0;outlineConnect=0;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="1">
          <mxGeometry x="690" y="40" width="80" height="850" as="geometry" />
        </mxCell>
        <mxCell id="vn" value=":VNPay" style="shape=umlLifeline;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=1;collapsible=0;recursiveResize=0;outlineConnect=0;fillColor=#ffe6cc;strokeColor=#d79b00;" vertex="1" parent="1">
          <mxGeometry x="820" y="40" width="80" height="850" as="geometry" />
        </mxCell>

        <!-- Section 1: Apply Voucher -->
        <mxCell id="note1" value="[1] Apply Voucher (UserVoucher Wallet)" style="text;html=1;strokeColor=none;fillColor=#dae8fc;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="50" y="110" width="220" height="20" as="geometry" />
        </mxCell>

        <mxCell id="msg1" value="Nhập voucher + bấm Áp dụng" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;" edge="1" parent="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="65" y="140" as="sourcePoint" />
            <mxPoint x="205" y="140" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <mxCell id="msg2" value="applyVoucher(code, total)" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;" edge="1" parent="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="205" y="170" as="sourcePoint" />
            <mxPoint x="355" y="170" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <mxCell id="msg3" value="POST /vouchers/apply" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;" edge="1" parent="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="355" y="200" as="sourcePoint" />
            <mxPoint x="605" y="200" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- Check Voucher master data -->
        <mxCell id="msg4a" value="findOne Voucher(code)" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;" edge="1" parent="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="605" y="230" as="sourcePoint" />
            <mxPoint x="730" y="230" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <mxCell id="msg4b" value="voucher data" style="html=1;verticalAlign=bottom;endArrow=open;dashed=1;endSize=8;rounded=0;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="730" y="250" as="sourcePoint" />
            <mxPoint x="605" y="250" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- Check UserVoucher wallet -->
        <mxCell id="msg4c" value="findOne UserVoucher(userId, voucherId)" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;strokeColor=#f5a623;" edge="1" parent="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="605" y="280" as="sourcePoint" />
            <mxPoint x="730" y="280" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <mxCell id="msg4d" value="{quantity, usedCount}" style="html=1;verticalAlign=bottom;endArrow=open;dashed=1;endSize=8;rounded=0;strokeColor=#f5a623;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="730" y="300" as="sourcePoint" />
            <mxPoint x="605" y="300" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- Validate check -->
        <mxCell id="note-validate" value="usedCount &lt; quantity ?" style="text;html=1;strokeColor=#f5a623;fillColor=#fff8e1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;fontSize=10;fontStyle=2;" vertex="1" parent="1">
          <mxGeometry x="560" y="315" width="130" height="25" as="geometry" />
        </mxCell>

        <mxCell id="msg6" value="{discountAmount, remainingUses}" style="html=1;verticalAlign=bottom;endArrow=open;dashed=1;endSize=8;rounded=0;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="605" y="360" as="sourcePoint" />
            <mxPoint x="355" y="360" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <mxCell id="msg7" value="response" style="html=1;verticalAlign=bottom;endArrow=open;dashed=1;endSize=8;rounded=0;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="355" y="390" as="sourcePoint" />
            <mxPoint x="205" y="390" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <mxCell id="msg8" value="Update tổng tiền + hiển thị lượt còn" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;exitX=1;exitY=0;exitDx=0;exitDy=0;entryX=1;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="205" y="420" as="sourcePoint" />
            <mxPoint x="205" y="450" as="targetPoint" />
            <Array as="points">
              <mxPoint x="260" y="420" />
              <mxPoint x="260" y="450" />
            </Array>
          </mxGeometry>
        </mxCell>

        <!-- Section 2: Confirmation Modal (NEW) -->
        <mxCell id="note2" value="[2] Xác nhận thông tin trước thanh toán (Modal)" style="text;html=1;strokeColor=none;fillColor=#e8f5e9;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="50" y="480" width="280" height="20" as="geometry" />
        </mxCell>

        <mxCell id="msg9" value="Click nút Thanh Toán" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;" edge="1" parent="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="65" y="510" as="sourcePoint" />
            <mxPoint x="205" y="510" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- NEW: Show Modal -->
        <mxCell id="msg-modal1" value="Hiển thị Modal xác nhận" style="html=1;verticalAlign=bottom;endArrow=open;dashed=1;endSize=8;rounded=0;strokeColor=#4caf50;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="205" y="540" as="sourcePoint" />
            <mxPoint x="65" y="540" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- Modal Content Note -->
        <mxCell id="note-modal" value="Modal hiển thị:&#xa;- Thông tin phim&#xa;- Rạp, suất chiếu&#xa;- Ghế, combo&#xa;- Tổng tiền" style="shape=note;whiteSpace=wrap;html=1;size=14;verticalAlign=top;align=left;spacingLeft=5;spacingTop=2;fillColor=#e8f5e9;strokeColor=#4caf50;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="50" y="550" width="100" height="80" as="geometry" />
        </mxCell>

        <!-- NEW: User confirms -->
        <mxCell id="msg-modal2" value="Tick checkbox điều khoản + Click Thanh Toán" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;strokeColor=#4caf50;" edge="1" parent="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="65" y="650" as="sourcePoint" />
            <mxPoint x="205" y="650" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- Section 3: Create Order & Payment -->
        <mxCell id="note3" value="[3] Create Order &amp; Payment (Consume Voucher)" style="text;html=1;strokeColor=none;fillColor=#d5e8d4;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="50" y="680" width="280" height="20" as="geometry" />
        </mxCell>

        <mxCell id="msg10" value="createOrder(seats, combos, voucherCode)" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;" edge="1" parent="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="205" y="710" as="sourcePoint" />
            <mxPoint x="480" y="710" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <mxCell id="msg11" value="POST /orders" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;" edge="1" parent="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="480" y="740" as="sourcePoint" />
            <mxPoint x="605" y="740" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- Update UserVoucher usedCount -->
        <mxCell id="msg11b" value="UserVoucher.usedCount++" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;strokeColor=#f5a623;" edge="1" parent="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="605" y="770" as="sourcePoint" />
            <mxPoint x="730" y="770" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <mxCell id="msg12" value="create Order (PENDING)" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;" edge="1" parent="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="605" y="800" as="sourcePoint" />
            <mxPoint x="730" y="800" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <mxCell id="msg13" value="{orderNo, paymentUrl}" style="html=1;verticalAlign=bottom;endArrow=open;dashed=1;endSize=8;rounded=0;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="605" y="830" as="sourcePoint" />
            <mxPoint x="480" y="830" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <mxCell id="msg14" value="response" style="html=1;verticalAlign=bottom;endArrow=open;dashed=1;endSize=8;rounded=0;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="480" y="860" as="sourcePoint" />
            <mxPoint x="205" y="860" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <mxCell id="msg15" value="Redirect paymentUrl" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;" edge="1" parent="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="205" y="890" as="sourcePoint" />
            <mxPoint x="860" y="890" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- Legend -->
        <mxCell id="legend1" value="Màu cam: Logic UserVoucher Wallet" style="text;html=1;strokeColor=#f5a623;fillColor=#fff8e1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;fontSize=10;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="820" y="110" width="190" height="25" as="geometry" />
        </mxCell>
        <mxCell id="legend2" value="Màu xanh: Modal xác nhận (MỚI)" style="text;html=1;strokeColor=#4caf50;fillColor=#e8f5e9;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;fontSize=10;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="820" y="140" width="190" height="25" as="geometry" />
        </mxCell></root></mxGraphModel></diagram></mxfile>
