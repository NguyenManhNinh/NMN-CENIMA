<mxfile host="app.diagrams.net" modified="2026-01-16T08:01:43.000Z" agent="Mozilla/5.0" version="21.0.0" type="device">
  <diagram name="Sequence - Toggle Like" id="sequence-toggle-like">
    <mxGraphModel dx="1200" dy="800" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1400" pageHeight="1000" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />

        <!-- TITLE -->
        <mxCell id="title" value="&lt;b&gt;SEQUENCE DIAGRAM – TOGGLE LIKE DIỄN VIÊN&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=16;" vertex="1" parent="1">
          <mxGeometry x="400" y="20" width="400" height="30" as="geometry" />
        </mxCell>

        <!-- ==================== PARTICIPANTS ==================== -->
        <!-- User -->
        <mxCell id="p-user" value="&lt;b&gt;User&lt;/b&gt;" style="shape=umlLifeline;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=1;dropTarget=0;collapsible=0;recursiveResize=0;outlineConnect=0;portConstraint=eastwest;newEdgeStyle={&quot;curved&quot;:0,&quot;rounded&quot;:0};fillColor=#dae8fc;strokeColor=#6c8ebf;size=40;" vertex="1" parent="1">
          <mxGeometry x="60" y="70" width="80" height="780" as="geometry" />
        </mxCell>

        <!-- ActorsPage -->
        <mxCell id="p-actors" value="&lt;b&gt;ActorsPage&lt;/b&gt;&lt;br&gt;(React)" style="shape=umlLifeline;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=1;dropTarget=0;collapsible=0;recursiveResize=0;outlineConnect=0;portConstraint=eastwest;newEdgeStyle={&quot;curved&quot;:0,&quot;rounded&quot;:0};fillColor=#d5e8d4;strokeColor=#82b366;size=50;" vertex="1" parent="1">
          <mxGeometry x="200" y="70" width="100" height="780" as="geometry" />
        </mxCell>

        <!-- localStorage -->
        <mxCell id="p-storage" value="&lt;b&gt;localStorage&lt;/b&gt;" style="shape=umlLifeline;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=1;dropTarget=0;collapsible=0;recursiveResize=0;outlineConnect=0;portConstraint=eastwest;newEdgeStyle={&quot;curved&quot;:0,&quot;rounded&quot;:0};fillColor=#f5f5f5;strokeColor=#666666;size=40;" vertex="1" parent="1">
          <mxGeometry x="360" y="70" width="90" height="780" as="geometry" />
        </mxCell>

        <!-- personApi -->
        <mxCell id="p-api" value="&lt;b&gt;personApi&lt;/b&gt;" style="shape=umlLifeline;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=1;dropTarget=0;collapsible=0;recursiveResize=0;outlineConnect=0;portConstraint=eastwest;newEdgeStyle={&quot;curved&quot;:0,&quot;rounded&quot;:0};fillColor=#e1d5e7;strokeColor=#9673a6;size=40;" vertex="1" parent="1">
          <mxGeometry x="510" y="70" width="90" height="780" as="geometry" />
        </mxCell>

        <!-- Backend -->
        <mxCell id="p-backend" value="&lt;b&gt;Backend&lt;/b&gt;&lt;br&gt;(personController)" style="shape=umlLifeline;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=1;dropTarget=0;collapsible=0;recursiveResize=0;outlineConnect=0;portConstraint=eastwest;newEdgeStyle={&quot;curved&quot;:0,&quot;rounded&quot;:0};fillColor=#fff2cc;strokeColor=#d6b656;size=50;" vertex="1" parent="1">
          <mxGeometry x="660" y="70" width="100" height="780" as="geometry" />
        </mxCell>

        <!-- MongoDB -->
        <mxCell id="p-mongo" value="&lt;b&gt;MongoDB&lt;/b&gt;&lt;br&gt;(persons)" style="shape=umlLifeline;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=1;dropTarget=0;collapsible=0;recursiveResize=0;outlineConnect=0;portConstraint=eastwest;newEdgeStyle={&quot;curved&quot;:0,&quot;rounded&quot;:0};fillColor=#f8cecc;strokeColor=#b85450;size=50;" vertex="1" parent="1">
          <mxGeometry x="820" y="70" width="100" height="780" as="geometry" />
        </mxCell>

        <!-- ==================== MESSAGES ==================== -->
        <!-- 1. User click Like -->
        <mxCell id="m1" value="1. click Like button" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;fontSize=10;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="100" y="145" as="sourcePoint" />
            <mxPoint x="245" y="145" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- 2. Check likeLoading -->
        <mxCell id="m2" value="2. check likeLoading[actorId]" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;fontSize=10;dashed=1;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="255" y="175" as="sourcePoint" />
            <mxPoint x="255" y="195" as="targetPoint" />
            <Array as="points">
              <mxPoint x="285" y="175" />
              <mxPoint x="285" y="195" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="m2-note" value="&lt;i&gt;if true → return&lt;/i&gt;" style="text;html=1;strokeColor=none;fillColor=#ffffcc;align=left;verticalAlign=middle;fontSize=9;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="290" y="178" width="70" height="18" as="geometry" />
        </mxCell>

        <!-- 3. Get prevLiked from localStorage -->
        <mxCell id="m3" value="3. getItem(&quot;actor_liked_{id}&quot;)" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;fontSize=10;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="255" y="220" as="sourcePoint" />
            <mxPoint x="400" y="220" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- 4. Return prevLiked -->
        <mxCell id="m4" value="4. prevLiked (true/false)" style="html=1;verticalAlign=bottom;endArrow=open;dashed=1;curved=0;rounded=0;fontSize=10;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="400" y="245" as="sourcePoint" />
            <mxPoint x="255" y="245" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- 5. Set likeLoading = true -->
        <mxCell id="m5" value="5. setLikeLoading[actorId] = true" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;fontSize=10;dashed=1;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="255" y="275" as="sourcePoint" />
            <mxPoint x="255" y="295" as="targetPoint" />
            <Array as="points">
              <mxPoint x="285" y="275" />
              <mxPoint x="285" y="295" />
            </Array>
          </mxGeometry>
        </mxCell>

        <!-- ACTIVATION BAR: Optimistic Update -->
        <mxCell id="act-opt" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="245" y="310" width="20" height="60" as="geometry" />
        </mxCell>
        <mxCell id="opt-label" value="&lt;b&gt;OPTIMISTIC&lt;br&gt;UPDATE&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;fontSize=9;fontColor=#2d5016;" vertex="1" parent="1">
          <mxGeometry x="155" y="320" width="80" height="30" as="geometry" />
        </mxCell>

        <!-- 6. Update likeStates (UI) -->
        <mxCell id="m6" value="6. setLikeStates({nextLiked, nextCount})" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;fontSize=10;dashed=1;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="265" y="325" as="sourcePoint" />
            <mxPoint x="265" y="345" as="targetPoint" />
            <Array as="points">
              <mxPoint x="295" y="325" />
              <mxPoint x="295" y="345" />
            </Array>
          </mxGeometry>
        </mxCell>

        <!-- 7. Save to localStorage -->
        <mxCell id="m7" value="7. setItem(likeKey, nextLiked)" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;fontSize=10;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="265" y="365" as="sourcePoint" />
            <mxPoint x="400" y="365" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- 8. Call API -->
        <mxCell id="m8" value="8. togglePersonLikeAPI(actorId, action)" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;fontSize=10;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="255" y="400" as="sourcePoint" />
            <mxPoint x="550" y="400" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- 9. POST request -->
        <mxCell id="m9" value="9. POST /persons/:id/like {action}" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;fontSize=10;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="555" y="430" as="sourcePoint" />
            <mxPoint x="705" y="430" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- ACTIVATION BAR: Backend processing -->
        <mxCell id="act-be" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="700" y="445" width="20" height="80" as="geometry" />
        </mxCell>

        <!-- 10. Validate action -->
        <mxCell id="m10" value="10. validate action ('like'/'unlike')" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;fontSize=10;dashed=1;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="715" y="460" as="sourcePoint" />
            <mxPoint x="715" y="480" as="targetPoint" />
            <Array as="points">
              <mxPoint x="745" y="460" />
              <mxPoint x="745" y="480" />
            </Array>
          </mxGeometry>
        </mxCell>

        <!-- 11. MongoDB update -->
        <mxCell id="m11" value="11. findByIdAndUpdate($inc: {likeCount: ±1})" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;fontSize=10;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="720" y="495" as="sourcePoint" />
            <mxPoint x="865" y="495" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- 12. MongoDB return -->
        <mxCell id="m12" value="12. updated person" style="html=1;verticalAlign=bottom;endArrow=open;dashed=1;curved=0;rounded=0;fontSize=10;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="865" y="520" as="sourcePoint" />
            <mxPoint x="720" y="520" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- 13. Backend response -->
        <mxCell id="m13" value="13. {success, data: {likeCount}}" style="html=1;verticalAlign=bottom;endArrow=open;dashed=1;curved=0;rounded=0;fontSize=10;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="705" y="550" as="sourcePoint" />
            <mxPoint x="555" y="550" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- 14. API return -->
        <mxCell id="m14" value="14. response" style="html=1;verticalAlign=bottom;endArrow=open;dashed=1;curved=0;rounded=0;fontSize=10;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="550" y="575" as="sourcePoint" />
            <mxPoint x="255" y="575" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- ==================== ALT FRAGMENT: SUCCESS ==================== -->
        <mxCell id="alt-frame" value="" style="shape=umlFrame;whiteSpace=wrap;html=1;pointerEvents=0;width=40;height=20;fillColor=none;strokeColor=#666666;" vertex="1" parent="1">
          <mxGeometry x="170" y="600" width="200" height="110" as="geometry" />
        </mxCell>
        <mxCell id="alt-label" value="&lt;b&gt;alt&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="175" y="602" width="30" height="18" as="geometry" />
        </mxCell>
        <mxCell id="alt-cond1" value="[API Success]" style="text;html=1;strokeColor=none;fillColor=#d5e8d4;align=left;verticalAlign=middle;fontSize=9;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="210" y="603" width="70" height="16" as="geometry" />
        </mxCell>

        <!-- 15. Sync likeCount -->
        <mxCell id="m15" value="15. sync likeCount from server" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;fontSize=10;dashed=1;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="255" y="640" as="sourcePoint" />
            <mxPoint x="255" y="660" as="targetPoint" />
            <Array as="points">
              <mxPoint x="285" y="640" />
              <mxPoint x="285" y="660" />
            </Array>
          </mxGeometry>
        </mxCell>

        <!-- 16. Clear loading -->
        <mxCell id="m16" value="16. setLikeLoading[actorId] = false" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;fontSize=10;dashed=1;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="255" y="680" as="sourcePoint" />
            <mxPoint x="255" y="700" as="targetPoint" />
            <Array as="points">
              <mxPoint x="285" y="680" />
              <mxPoint x="285" y="700" />
            </Array>
          </mxGeometry>
        </mxCell>

        <!-- ==================== ALT FRAGMENT: ERROR ==================== -->
        <mxCell id="alt-frame2" value="" style="shape=umlFrame;whiteSpace=wrap;html=1;pointerEvents=0;width=40;height=20;fillColor=none;strokeColor=#b85450;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="170" y="720" width="250" height="120" as="geometry" />
        </mxCell>
        <mxCell id="alt-cond2" value="[API Error - Rollback]" style="text;html=1;strokeColor=none;fillColor=#f8cecc;align=left;verticalAlign=middle;fontSize=9;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="210" y="722" width="100" height="16" as="geometry" />
        </mxCell>

        <!-- 17. Rollback localStorage -->
        <mxCell id="m17" value="17. setItem(likeKey, prevLiked) [rollback]" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;fontSize=10;strokeColor=#b85450;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="255" y="755" as="sourcePoint" />
            <mxPoint x="400" y="755" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- 18. Rollback likeStates -->
        <mxCell id="m18" value="18. setLikeStates({prevLiked, prevCount})" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;fontSize=10;dashed=1;strokeColor=#b85450;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="255" y="785" as="sourcePoint" />
            <mxPoint x="255" y="805" as="targetPoint" />
            <Array as="points">
              <mxPoint x="285" y="785" />
              <mxPoint x="285" y="805" />
            </Array>
          </mxGeometry>
        </mxCell>

        <!-- 19. Clear loading -->
        <mxCell id="m19" value="19. setLikeLoading = false" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;fontSize=10;dashed=1;strokeColor=#b85450;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="255" y="820" as="sourcePoint" />
            <mxPoint x="255" y="835" as="targetPoint" />
            <Array as="points">
              <mxPoint x="285" y="820" />
              <mxPoint x="285" y="835" />
            </Array>
          </mxGeometry>
        </mxCell>

        <!-- ==================== LEGEND ==================== -->
        <mxCell id="legend-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;dashed=1;" vertex="1" parent="1">
          <mxGeometry x="960" y="80" width="180" height="160" as="geometry" />
        </mxCell>
        <mxCell id="legend-title" value="&lt;b&gt;CHÚ THÍCH&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="960" y="85" width="180" height="20" as="geometry" />
        </mxCell>

        <mxCell id="leg1" value="" style="endArrow=block;html=1;rounded=0;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="975" y="120" as="sourcePoint" />
            <mxPoint x="1015" y="120" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="leg1-text" value="Sync message" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1020" y="112" width="80" height="20" as="geometry" />
        </mxCell>

        <mxCell id="leg2" value="" style="endArrow=open;dashed=1;html=1;rounded=0;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="975" y="145" as="sourcePoint" />
            <mxPoint x="1015" y="145" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="leg2-text" value="Return / Async" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1020" y="137" width="80" height="20" as="geometry" />
        </mxCell>

        <mxCell id="leg3" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="975" y="165" width="15" height="25" as="geometry" />
        </mxCell>
        <mxCell id="leg3-text" value="Activation bar" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="995" y="167" width="80" height="20" as="geometry" />
        </mxCell>

        <mxCell id="leg4" value="" style="shape=umlFrame;whiteSpace=wrap;html=1;width=25;height=12;fillColor=none;strokeColor=#666666;" vertex="1" parent="1">
          <mxGeometry x="975" y="200" width="35" height="25" as="geometry" />
        </mxCell>
        <mxCell id="leg4-text" value="Alt fragment" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1015" y="202" width="80" height="20" as="geometry" />
        </mxCell>

        <!-- ==================== NOTES ==================== -->
        <mxCell id="note1" value="&lt;b&gt;Ghi chú:&lt;/b&gt;&lt;br&gt;• Optimistic Update: UI cập nhật&lt;br&gt;  ngay trước khi API trả về&lt;br&gt;• Rollback: hoàn tác nếu API lỗi&lt;br&gt;• likeLoading: chống spam click&lt;br&gt;• $inc: atomic update MongoDB" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;fillColor=#ffffcc;strokeColor=#999999;align=left;verticalAlign=top;spacing=5;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="960" y="270" width="180" height="110" as="geometry" />
        </mxCell>

      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
