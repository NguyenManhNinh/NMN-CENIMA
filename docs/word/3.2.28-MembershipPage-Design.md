## 3.2.28. Thiết kế hệ thống – Thông tin Thành viên (MembershipPage)

### 3.2.28.1. Kiến trúc tổng thể phân hệ thông tin thành viên

Phân hệ thông tin thành viên được thiết kế theo mô hình kiến trúc web tách lớp, gồm ba tầng chính hoạt động độc lập và giao tiếp thông qua REST API.

Mô hình kiến trúc và thành phần:
Frontend:
•	`MembershipPage.jsx`: Component chính chịu trách nhiệm render trang thành viên với danh sách section, ảnh banner, nội dung HTML và thanh Quick Navigation sidebar.
•	`membershipInfoApi.js`: Module API client sử dụng Axios instance riêng để gọi các endpoint backend.
•	State Management: Sử dụng React hooks (useState, useEffect) để quản lý 4 trạng thái chính: membershipData, loading, error, imageLoadingMap/imageErrorMap.
•	Scroll Navigation: Sử dụng useRef và scrollIntoView để cuộn mượt đến section khi click vào Quick Navigation.

Backend:
•	`membershipInfoController.js`: Controller xử lý 3 endpoint: lấy trang thành viên active (Public), cập nhật trang thành viên (Admin), lấy tất cả trang thành viên (Admin). Tích hợp hàm cleanHtml() sử dụng thư viện sanitize-html để lọc nội dung HTML trước khi lưu.
•	`membershipInfoRoutes.js`: Định nghĩa các route API, phân quyền Public/Admin qua middleware protect + restrictTo('admin').

Database:
•	Collection `membershipinfos`: Lưu trữ thông tin thành viên với sub-document sections (nhúng).
•	Schema áp dụng pre-save hook để đảm bảo ràng buộc single-active.
•	Index trên trường `status` để tối ưu truy vấn lấy trang thành viên active.

Hình 3.xx – Sơ đồ kiến trúc tổng thể phân hệ thông tin thành viên

### 3.2.28.2. Use Case Diagram – Thông tin Thành viên

Sơ đồ Use Case mô tả các tác nhân và chức năng của phân hệ thông tin thành viên:

Tác nhân:
•	Guest/User: Xem thông tin thành viên → Điều hướng giữa các section → Xem ảnh banner minh họa.
•	Admin: Cập nhật nội dung thành viên → Quản lý sections → Thêm/sửa/xóa section → Xem tất cả phiên bản.

Các Use Case chính:
•	UC-MB-01: Xem thông tin thành viên (Primary – Guest/User)
Mô tả: Người dùng truy cập trang /thanh-vien, hệ thống gọi API lấy trang thành viên active và hiển thị danh sách section theo sortOrder.
•	UC-MB-02: Điều hướng nhanh đến section (Guest/User)
Mô tả: Người dùng click vào mục trong Quick Navigation sidebar, trang cuộn mượt đến section tương ứng.
•	UC-MB-03: Xem ảnh banner minh họa (Guest/User)
Mô tả: Hệ thống hiển thị ảnh banner cho các section có imageUrl, với skeleton loading và fallback khi lỗi.
•	UC-MB-04: Cập nhật nội dung thành viên (Admin)
Mô tả: Admin gửi request PUT với thông tin trang thành viên mới, backend validate, sanitize HTML content và lưu vào database.
•	UC-MB-05: Xem tất cả phiên bản nội dung (Admin)
Mô tả: Admin xem danh sách tất cả trang thành viên (bao gồm draft) để quản lý.

Hình 3.xx. Sơ đồ Use Case Diagram – Phân hệ Thông tin Thành viên

### 3.2.28.3. Activity Diagram – Luồng xem thông tin thành viên

Sơ đồ Activity mô tả luồng xử lý khi người dùng truy cập trang thành viên:

1. Người dùng truy cập trang /thanh-vien
2. Hệ thống hiển thị Loading overlay (logo NMN Cinema + spinner)
3. Frontend gọi API GET /api/v1/membership-info
4. [Phân nhánh] API response:
   a. Thành công (200):
     - Lưu dữ liệu trang thành viên vào state
     - Render danh sách section theo sortOrder
     - Với mỗi section:
       + Hiển thị tiêu đề section
       + Nếu có imageUrl → Hiển thị skeleton loading → Tải ảnh banner
         * Ảnh tải thành công → Ẩn skeleton, hiển thị ảnh với opacity transition
         * Ảnh tải thất bại → Hiển thị fallback "Ảnh đang được cập nhật"
       + Render nội dung HTML trong wrapper có sẵn style
     - Render Quick Navigation sidebar với danh sách tiêu đề section
   b. 404 (chưa có nội dung thành viên):
     - Hiển thị thông báo "Chưa có thông tin thành viên"
   c. Lỗi khác (500/timeout):
     - Hiển thị thông báo lỗi + nút "Thử lại"
5. [Tương tác] Người dùng click Quick Navigation:
   - Xác định section target qua ref
   - Gọi scrollIntoView({behavior: 'smooth'}) để cuộn mượt đến section
6. Kết thúc

Hình 3.xx. Sơ đồ Activity Diagram – Luồng xem thông tin thành viên

### 3.2.28.4. Sequence Diagram – Tải và hiển thị thông tin thành viên

Sơ đồ Sequence mô tả tương tác giữa các thành phần khi tải trang thành viên:

Các đối tượng tham gia:
•	User (Browser)
•	MembershipPage (React Component)
•	membershipInfoApi (Axios Client)
•	MembershipInfoController (Backend)
•	MembershipInfo (MongoDB Model)

Luồng tương tác:
1. User → MembershipPage: Truy cập /thanh-vien
2. MembershipPage: setState(loading=true)
3. MembershipPage → membershipInfoApi: getMembershipInfoAPI()
4. membershipInfoApi → MembershipInfoController: GET /api/v1/membership-info
5. MembershipInfoController → MembershipInfo: findOne({status:'active'}).lean()
6. MembershipInfo → MembershipInfoController: membership document (hoặc null)
7. [alt] membership tồn tại:
   a. MembershipInfoController: Sort sections by sortOrder
   b. MembershipInfoController → membershipInfoApi: 200 {success:true, data:membership}
   c. membershipInfoApi → MembershipPage: response.data
   d. MembershipPage: setState(membershipData=data, loading=false)
   e. MembershipPage: Tạo sectionRefs cho mỗi section
   f. MembershipPage → User: Render tiêu đề + sections + Quick Navigation
8. [alt] membership = null:
   a. MembershipInfoController → membershipInfoApi: 404 {success:false}
   b. MembershipPage: setState(membershipData=null, loading=false)
   c. MembershipPage → User: Hiển thị "Chưa có thông tin thành viên"

Hình 3.xx. Sơ đồ Sequence Diagram – Tải và hiển thị thông tin thành viên

### 3.2.28.5. Sequence Diagram – Admin cập nhật thông tin thành viên

Sơ đồ Sequence mô tả luồng Admin cập nhật nội dung trang thành viên:

Các đối tượng tham gia:
•	Admin (Browser)
•	AdminPanel (React Component)
•	MembershipInfoController (Backend)
•	authMiddleware (JWT + Role Check)
•	sanitize-html (HTML Sanitizer)
•	MembershipInfo (MongoDB Model)

Luồng tương tác:
1. Admin → AdminPanel: Nhập thông tin trang thành viên mới (title, sections[])
2. AdminPanel → MembershipInfoController: PUT /api/v1/membership-info (Bearer token)
3. MembershipInfoController → authMiddleware: Verify JWT + check role='admin'
4. [alt] Unauthorized:
   a. authMiddleware → AdminPanel: 401/403
5. MembershipInfoController: Validate sections (phải là mảng, length > 0)
6. [alt] Validation fail:
   a. MembershipInfoController → AdminPanel: 400 "Phải có ít nhất 1 section nội dung"
7. MembershipInfoController → sanitize-html: cleanHtml(section.content) cho mỗi section
8. sanitize-html → MembershipInfoController: HTML đã được lọc (loại bỏ script, inline style, class)
9. MembershipInfoController → MembershipInfo: findOne({status:'active'})
10. [alt] Đã có trang thành viên active:
    a. MembershipInfoController: Cập nhật title, sections (đã sanitize), status
    b. MembershipInfo: pre-save hook → updateMany({status:'draft'}) cho các trang khác
    c. MembershipInfo: save()
11. [alt] Chưa có trang thành viên nào:
    a. MembershipInfoController → MembershipInfo: create({title, sections, status:'active'})
    b. MembershipInfo: pre-save hook (không có trang khác để chuyển draft)
12. MembershipInfoController → AdminPanel: 200 {success:true, data:membership}

Hình 3.xx. Sơ đồ Sequence Diagram – Admin cập nhật thông tin thành viên

### 3.2.28.6. Class Diagram rút gọn – Thông tin Thành viên

Mục đích:
Mô tả cấu trúc các lớp và mối quan hệ giữa chúng trong phân hệ MembershipPage, bao gồm frontend components, API client và backend layers.

Phạm vi:
•	Frontend: MembershipPage component, membershipInfoApi module
•	Backend: MembershipInfoController (tích hợp cleanHtml), MembershipInfo Model (với embedded MembershipSection)
•	Middleware: authMiddleware (protect + restrictTo)
•	Thư viện: sanitize-html (HTML sanitizer)
•	Mối quan hệ: Dependency, Composition (sections embedded trong membership)

Các lớp chính:

**Frontend Layer:**

| Lớp | Thuộc tính | Phương thức |
|:----|:-----------|:------------|
| MembershipPage | -membershipData:Object, -loading:Boolean, -error:String, -imageLoadingMap:Object, -imageErrorMap:Object, -sectionRefs:Object | +handleImageLoad(slug), +handleImageError(slug), +scrollToSection(slug) |
| membershipInfoApi | -api:AxiosInstance | +getMembershipInfoAPI():Promise |

**Backend Layer:**

| Lớp | Phương thức |
|:----|:------------|
| MembershipInfoController | +getMembershipInfo(req,res), +updateMembershipInfo(req,res), +getAllMembershipInfo(req,res), -cleanHtml(dirty):String |
| MembershipInfoRoutes | GET / (Public), PUT / (Admin), GET /admin/all (Admin) |

**Model Layer:**

| Lớp | Thuộc tính | Ràng buộc |
|:----|:-----------|:----------|
| MembershipInfo | title:String, sections:[MembershipSection], status:String | status ∈ {active,draft}, sections.length ≥ 1, pre-save: single-active |
| MembershipSection | title:String, slug:String, imageUrl:String, content:String, sortOrder:Number | title required, slug required |

Quan hệ:
•	MembershipPage «uses» membershipInfoApi (Dependency)
•	membershipInfoApi «HTTP» MembershipInfoController (Dependency)
•	MembershipInfoController «uses» MembershipInfo Model (Dependency)
•	MembershipInfoController «uses» sanitize-html (Dependency – cleanHtml)
•	MembershipInfo «contains» MembershipSection (Composition – embedded sub-document)
•	MembershipInfoRoutes «uses» authMiddleware (Dependency – cho Admin routes)

Hình 3.xx. Sơ đồ Class Diagram rút gọn – Phân hệ Thông tin Thành viên

### 3.2.28.7. Thiết kế cơ sở dữ liệu – Collection membershipinfos

Bảng mô tả Collection membershipinfos:

| STT | Tên trường (Field) | Kiểu dữ liệu | Mô tả | Ràng buộc |
|:----|:-------------------|:-------------|:------|:----------|
| 1 | _id | ObjectId | Định danh trang thành viên | PK |
| 2 | title | String | Tiêu đề trang thành viên (VD: "Chương trình Thành viên NMN Cinema Membership") | Required, trim, Default="Chương trình Thành viên NMN Cinema Membership \| Tích điểm và đổi thưởng" |
| 3 | sections | Array\<Object\> | Danh sách section nội dung (embedded sub-document) | Required, min length 1 |
| 4 | sections[].title | String | Tiêu đề section (VD: "1. Thể lệ và quy định về Chương trình Thành viên") | Required, trim |
| 5 | sections[].slug | String | Slug cho URL hash và scroll navigation (VD: "the-le") | Required, trim |
| 6 | sections[].imageUrl | String | URL ảnh banner minh họa (tùy chọn, không bắt buộc) | Default="" |
| 7 | sections[].content | String | Nội dung HTML đã được sanitize | Default="" |
| 8 | sections[].sortOrder | Number | Thứ tự sắp xếp (số nhỏ hiển thị trước) | Default=0 |
| 9 | status | String | Trạng thái hiển thị | Enum: active/draft, Default="active", Indexed |
| 10 | createdAt | Date | Ngày tạo | Auto (timestamps) |
| 11 | updatedAt | Date | Ngày cập nhật | Auto (timestamps) |

Index & ràng buộc:
•	Index trên trường `status` để tối ưu truy vấn lấy trang thành viên active.
•	Pre-save hook đảm bảo ràng buộc single-active: khi lưu trang với status='active', tự động chuyển các trang khác sang 'draft'.
•	Validator trên trường `sections`: mảng phải có ít nhất 1 phần tử.
•	Sub-schema `MembershipSection` sử dụng `_id: false` để không tạo _id tự động cho mỗi section.

Thiết kế lựa chọn nhúng (embed) thay vì tham chiếu (reference):
•	Sections được nhúng trực tiếp trong document MembershipInfo thay vì tách thành collection riêng, vì sections luôn được đọc cùng trang thành viên và số lượng sections nhỏ (thường 3-5 sections), phù hợp với nguyên tắc data modeling của MongoDB "nhúng khi dữ liệu cần hiển thị cùng nhau thường xuyên".

### 3.2.28.8. Thiết kế bảo mật – HTML Sanitization

Phân hệ thành viên triển khai lớp bảo mật HTML Sanitization tại tầng backend để đảm bảo nội dung từ Admin không chứa mã độc và không phá vỡ giao diện frontend.

Cơ chế hoạt động:
•	Hàm `cleanHtml()` trong MembershipInfoController sử dụng thư viện `sanitize-html` để lọc nội dung HTML.
•	Quy trình: Admin nhập HTML → Controller nhận request → cleanHtml() lọc từng section.content → Lưu HTML đã sanitize vào DB → Frontend render HTML sạch.

Chính sách lọc:

| Loại | Cho phép | Bị loại bỏ |
|:-----|:---------|:-----------|
| Tags | p, br, strong, em, u, span, h2-h4, ul, ol, li, table, thead, tbody, tr, th, td, a | script, iframe, img, div, form, input, style, link |
| Attributes | a[href, target, rel], span[style] | class, id, onclick, onload, data-* |
| Styles | span: color (hex), font-weight (số) | Mọi inline style khác |
| Transforms | a tự động thêm target="_blank" rel="noopener noreferrer" | – |

Lợi ích:
•	Chống tấn công XSS (Cross-Site Scripting)
•	Đảm bảo giao diện đồng nhất: frontend wrapper CSS kiểm soát toàn bộ typography
•	Admin có thể nhập nội dung linh hoạt mà không phá layout
