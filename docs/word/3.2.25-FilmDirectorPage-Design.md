# 3.2.25. Thiết kế hệ thống – Danh sách đạo diễn (FilmDirectorPage)

## 3.2.25.1. Kiến trúc tổng thể phân hệ FilmDirectorPage

Phân hệ FilmDirectorPage được thiết kế theo mô hình kiến trúc web tách lớp, bao gồm 3 tầng chính hoạt động độc lập và giao tiếp thông qua REST API.

**Mô hình kiến trúc và thành phần:**

**Frontend (ReactJS):**
- `FilmDirectorPage.jsx`: Component chính chịu trách nhiệm render danh sách đạo diễn, xử lý bộ lọc quốc tịch, sắp xếp, phân trang và tương tác like.
- `personApi.js`: Module API client sử dụng Axios để gọi các endpoint backend.
- State Management: Sử dụng React hooks (useState, useEffect, useRef) để quản lý trạng thái local.
- URL State Sync: Đồng bộ bộ lọc và phân trang với URL params thông qua `useSearchParams`.

**Backend (Node.js/Express):**
- `personController.js`: Controller xử lý các request liên quan đến Person.
- `personRouter.js`: Định nghĩa các route API.

**Database (MongoDB):**
- Collection `persons`: Lưu trữ thông tin đạo diễn/diễn viên.
- Sử dụng Mongoose ODM với các method: `find()`, `countDocuments()`, `distinct()`, `findByIdAndUpdate()`.
- Index trên các trường: `role`, `isActive`, `nationality`, `viewCount`, `likeCount`.

**Hình 3.47. Sơ đồ kiến trúc tổng thể phân hệ FilmDirectorPage**

---

## 3.2.25.2. Use Case Diagram – FilmDirectorPage

**Mô tả:**
Use Case Diagram mô tả các chức năng chính của trang danh sách đạo diễn và mối quan hệ giữa các tác nhân với hệ thống.

**Tác nhân:**
- Guest (Khách): Có thể xem danh sách, lọc, sắp xếp, phân trang và xem chi tiết đạo diễn.
- User (Thành viên): Có tất cả quyền của Guest, thêm chức năng thích/bỏ thích đạo diễn.

**Các Use Case:**
| UC ID | Tên Use Case | Tác nhân |
|:------|:-------------|:---------|
| UC-DR-01 | Xem danh sách đạo diễn | Guest, User |
| UC-DR-02 | Lọc theo quốc tịch | Guest, User |
| UC-DR-03 | Sắp xếp danh sách | Guest, User |
| UC-DR-04 | Phân trang | Guest, User |
| UC-DR-05 | Xem chi tiết đạo diễn | Guest, User |
| UC-DR-06 | Thích đạo diễn | User |
| UC-DR-07 | Bỏ thích đạo diễn | User |
| UC-DR-08 | Đặt lại bộ lọc | Guest, User |

**Quan hệ:**
- UC-DR-06 và UC-DR-07 `<<extend>>` từ UC-DR-01 (chỉ User mới thực hiện được).

**Hình 3.48. Sơ đồ Use Case Diagram – FilmDirectorPage**

```
PROMPT VẼ SƠ ĐỒ (Draw.io/PlantUML):
-----------------------------------
Vẽ Use Case Diagram với:
- Hệ thống: FilmDirectorPage (hình chữ nhật bao quanh)
- 2 Actor bên trái: Guest (hình người), User (hình người, kế thừa từ Guest)
- 8 Use Case (hình oval) bên trong hệ thống:
  1. Xem danh sách đạo diễn
  2. Lọc theo quốc tịch
  3. Sắp xếp danh sách
  4. Phân trang
  5. Xem chi tiết đạo diễn
  6. Thích đạo diễn (chỉ User)
  7. Bỏ thích đạo diễn (chỉ User)
  8. Đặt lại bộ lọc
- Guest nối đến UC 1-5, 8
- User nối đến UC 6, 7
- User kế thừa (generalization) từ Guest
- UC 6, 7 có <<extend>> đến UC 1
```

---

## 3.2.25.3. Activity Diagram – Luồng xem và lọc danh sách đạo diễn

**Mô tả:**
Activity Diagram mô tả luồng xử lý khi người dùng truy cập trang danh sách đạo diễn, thực hiện lọc và xem chi tiết.

**Luồng xử lý chính:**
1. Người dùng truy cập `/dao-dien`
2. Hệ thống đọc URL params (nếu có)
3. Gọi song song 3 API:
   - GET /api/v1/persons/nationalities?role=director
   - GET /api/v1/persons/directors (với params từ URL)
   - GET /api/v1/movies/now-showing
4. Hiển thị danh sách đạo diễn + bộ lọc + sidebar
5. [Decision] Người dùng thay đổi bộ lọc?
   - Có → Cập nhật URL params → Reset page = 1 → Gọi API directors → Quay lại bước 4
   - Không → Tiếp tục
6. [Decision] Người dùng chuyển trang?
   - Có → Cập nhật page → Gọi API → Scroll lên đầu → Quay lại bước 4
   - Không → Tiếp tục
7. [Decision] Người dùng click đạo diễn?
   - Có → Navigate `/dao-dien-chi-tiet/:slug` → Kết thúc
   - Không → Chờ tương tác tiếp

**Hình 3.49. Sơ đồ Activity Diagram – Luồng xem và lọc danh sách đạo diễn**

```
PROMPT VẼ SƠ ĐỒ (Draw.io/PlantUML):
-----------------------------------
Vẽ Activity Diagram với 3 swimlanes: Frontend | Backend API | MongoDB

Frontend:
- [●] Start: Truy cập /dao-dien
- Đọc URL params
- Gọi 3 API song song (fork)
- [◇] Decision: Dữ liệu trả về?
- Hiển thị danh sách + bộ lọc
- [◇] Thay đổi bộ lọc?
  - Có: Cập nhật URL → Reset page=1 → Loop lại gọi API
  - Không: tiếp
- [◇] Chuyển trang?
  - Có: Cập nhật page → Scroll top → Loop lại
  - Không: tiếp
- [◇] Click đạo diễn?
  - Có: Navigate /dao-dien-chi-tiet/:slug → [◉] End
  - Không: Chờ tương tác

Backend API:
- Nhận request GET /persons/directors
- Xử lý query params (page, limit, sort, nationality)
- Trả JSON response

MongoDB:
- Query collection persons với filter role=['director','both']
- Return documents
```

---

## 3.2.25.4. Sequence Diagram – Toggle Like đạo diễn

**Mô tả:**
Sequence Diagram mô tả luồng tương tác chi tiết khi người dùng thích/bỏ thích một đạo diễn, bao gồm cơ chế optimistic update và rollback khi lỗi.

**Participants:**
- User (Actor)
- FilmDirectorPage (Frontend Component)
- localStorage (Browser Storage)
- personApi (API Client)
- PersonController (Backend)
- Person Model (MongoDB)

**Luồng chính (Happy Path):**
1. User click nút Like
2. Frontend kiểm tra `likeLoading[id]` → nếu true thì return (chống spam)
3. Frontend đọc trạng thái từ localStorage: `director_liked_{id}`
4. Tính toán: `nextLiked = !currentLiked`, `nextCount = currentCount ± 1`
5. **[Optimistic Update]**:
   - Set `likeLoading[id] = true`
   - Update UI: isLiked, likeCount
   - Lưu localStorage
6. Gọi API: `POST /api/v1/persons/:id/like` với body `{ action: 'like'/'unlike' }`
7. Backend cập nhật MongoDB: `$inc: { likeCount: ±1 }`
8. Backend trả về `{ success: true, data: { likeCount: newCount } }`
9. Frontend sync likeCount từ response
10. Set `likeLoading[id] = false`

**Luồng lỗi (Rollback):**
- Nếu API lỗi → Rollback localStorage, isLiked, likeCount về giá trị cũ

**Hình 3.50. Sơ đồ Sequence Diagram – Toggle Like đạo diễn**

```
PROMPT VẼ SƠ ĐỒ (Draw.io/PlantUML):
-----------------------------------
Vẽ Sequence Diagram với 6 participants theo thứ tự:
User | FilmDirectorPage | localStorage | personApi | PersonController | Person

Luồng message:
1. User -> FilmDirectorPage: click nút Like
2. FilmDirectorPage -> FilmDirectorPage: check likeLoading[id]
3. FilmDirectorPage -> localStorage: get director_liked_{id}
4. localStorage --> FilmDirectorPage: currentLiked (true/false)
5. FilmDirectorPage -> FilmDirectorPage: calculate nextLiked, nextCount
6. Note over FilmDirectorPage: Optimistic Update
7. FilmDirectorPage -> localStorage: set director_liked_{id} = nextLiked
8. FilmDirectorPage -> FilmDirectorPage: update UI (isLiked, likeCount)
9. FilmDirectorPage -> personApi: togglePersonLikeAPI(id, action)
10. personApi -> PersonController: POST /persons/:id/like {action}
11. PersonController -> Person: findByIdAndUpdate($inc likeCount)
12. Person --> PersonController: updated document
13. PersonController --> personApi: {success, data: {likeCount}}
14. personApi --> FilmDirectorPage: response
15. FilmDirectorPage -> FilmDirectorPage: sync likeCount from server
16. FilmDirectorPage --> User: UI updated

alt [API Error]:
  17. personApi --> FilmDirectorPage: error
  18. FilmDirectorPage -> localStorage: rollback director_liked_{id}
  19. FilmDirectorPage -> FilmDirectorPage: rollback UI
```

---

## 3.2.25.5. Class Diagram rút gọn – FilmDirectorPage

**Mục đích:**
Mô tả cấu trúc các lớp và mối quan hệ giữa chúng trong phân hệ FilmDirectorPage, bao gồm frontend components, API client và backend layers.

**Phạm vi:**
- Frontend: FilmDirectorPage component, personApi module, movieApi module
- Backend: PersonController, Person Model
- Mối quan hệ: Dependency, Association

**Các lớp chính:**

| Layer | Lớp | Thuộc tính / Phương thức |
|:------|:----|:-------------------------|
| Frontend | FilmDirectorPage | directors[], nationalityOptions[], sidebarMovies[], selectedNationality, selectedSort, currentPage, totalPages, likeStates{}, likeLoading{} / loadDirectors(), handleToggleLike(), handlePageChange(), resetFilters() |
| Frontend | personApi | getDirectorsAPI(), getNationalitiesAPI(), togglePersonLikeAPI() |
| Frontend | movieApi | getNowShowingMoviesAPI() |
| Backend | PersonController | getDirectors(), getNationalities(), togglePersonLike() |
| Database | Person | _id, name, slug, role, avatar, shortBio, nationality, viewCount, likeCount, isActive, createdAt |

**Quan hệ:**
- FilmDirectorPage `-->` personApi: uses (dependency)
- FilmDirectorPage `-->` movieApi: uses (dependency)
- personApi `-->` PersonController: HTTP requests
- PersonController `-->` Person: Mongoose queries

**Hình 3.51. Sơ đồ Class Diagram rút gọn – FilmDirectorPage**

```
PROMPT VẼ SƠ ĐỒ (Draw.io/PlantUML):
-----------------------------------
Vẽ Class Diagram với 2 layers: Frontend Layer và Backend Layer

Frontend Layer:
┌─────────────────────────────────────┐
│ <<component>>                       │
│ FilmDirectorPage                    │
├─────────────────────────────────────┤
│ - directors: Array                  │
│ - nationalityOptions: Array         │
│ - sidebarMovies: Array              │
│ - selectedNationality: string       │
│ - selectedSort: string              │
│ - currentPage: number               │
│ - totalPages: number                │
│ - likeStates: Object                │
│ - likeLoading: Object               │
├─────────────────────────────────────┤
│ + loadDirectors(): void             │
│ + handleToggleLike(id, e): void     │
│ + handlePageChange(page): void      │
│ + resetFilters(): void              │
└─────────────────────────────────────┘
         │ uses              │ uses
         ▼                   ▼
┌────────────────┐   ┌────────────────┐
│ <<module>>     │   │ <<module>>     │
│ personApi      │   │ movieApi       │
├────────────────┤   ├────────────────┤
│ +getDirectors  │   │ +getNowShowing │
│ +getNational   │   │  MoviesAPI()   │
│  itiesAPI()    │   └────────────────┘
│ +togglePerson  │
│  LikeAPI()     │
└────────────────┘
         │ HTTP
         ▼
Backend Layer:
┌────────────────────────────────────┐
│ <<controller>>                     │
│ PersonController                   │
├────────────────────────────────────┤
│ + getDirectors(req, res): Response │
│ + getNationalities(req, res): Resp │
│ + togglePersonLike(req, res): Resp │
└────────────────────────────────────┘
         │ queries
         ▼
┌────────────────────────────────────┐
│ <<model>>                          │
│ Person                             │
├────────────────────────────────────┤
│ _id: ObjectId                      │
│ name: string                       │
│ slug: string                       │
│ role: enum ['actor','director']    │
│ avatar: string                     │
│ shortBio: string                   │
│ nationality: string                │
│ viewCount: number                  │
│ likeCount: number                  │
│ isActive: boolean                  │
│ createdAt: Date                    │
└────────────────────────────────────┘
```
