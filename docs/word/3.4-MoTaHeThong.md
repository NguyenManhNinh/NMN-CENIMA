# 3.4. Mô tả hệ thống

## 3.4.1. Kiến trúc tổng thể

Hệ thống NMN Cinema được xây dựng theo mô hình **Client-Server** với kiến trúc **3-tier**:

```
┌─────────────────────────────────────────────────────────────────┐
│                      PRESENTATION LAYER                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │ Web Client  │  │ Admin Panel │  │ Mobile App  │              │
│  │ (React)     │  │ (React)     │  │ (Future)    │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
└─────────────────────────────────────────────────────────────────┘
                              │ HTTPS/REST API
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      BUSINESS LAYER                              │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │              Express.js API Server (Node.js)                 ││
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐            ││
│  │  │ Auth    │ │ Movie   │ │ Booking │ │ Payment │            ││
│  │  │ Module  │ │ Module  │ │ Module  │ │ Module  │            ││
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘            ││
│  └─────────────────────────────────────────────────────────────┘│
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │ Socket.io   │  │ Redis Cache │  │ Job Queue   │              │
│  │ (Real-time) │  │ (Rate Limit)│  │ (Cron Jobs) │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        DATA LAYER                                │
│  ┌─────────────────────┐  ┌─────────────────────┐               │
│  │     MongoDB         │  │    File Storage     │               │
│  │  (25 Collections)   │  │  (Images, Uploads)  │               │
│  └─────────────────────┘  └─────────────────────┘               │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3.4.2. Các module chức năng

### Module 1: Quản lý người dùng (User Management)

| Chức năng | Mô tả |
|:----------|:------|
| Đăng ký/Đăng nhập | Email OTP, Google OAuth |
| Phân quyền | User, Staff, Manager, Admin |
| Profile | Thông tin cá nhân, avatar |
| Thành viên | Tích điểm, xếp hạng VIP/VVIP |

### Module 2: Quản lý nội dung (Content Management)

| Chức năng | Mô tả |
|:----------|:------|
| Phim | CRUD, poster, trailer, rating |
| Thể loại | Danh mục phim |
| Đạo diễn/Diễn viên | Thông tin, tiểu sử, phim đã tham gia |
| Rạp/Phòng chiếu | Quản lý cụm rạp, sơ đồ ghế |

### Module 3: Đặt vé (Booking)

| Chức năng | Mô tả |
|:----------|:------|
| Suất chiếu | Lịch chiếu theo ngày, rạp |
| Chọn ghế | Sơ đồ ghế real-time, giữ ghế tạm |
| Combo | Bắp nước đi kèm |
| Voucher | Mã giảm giá, kiểm tra điều kiện |

### Module 4: Thanh toán (Payment)

| Chức năng | Mô tả |
|:----------|:------|
| VNPay | Tích hợp cổng thanh toán |
| Idempotent | Chống duplicate callback |
| Vé QR | Xuất vé điện tử, gửi email |
| Check-in | Soát vé tại rạp |

### Module 5: Đánh giá & Tương tác

| Chức năng | Mô tả |
|:----------|:------|
| Bình luận | Review phim, reply, reaction |
| Rating | Đánh giá 1-5 sao |
| Báo cáo | Report nội dung vi phạm |
| Chat AI | Hỗ trợ khách hàng Gemini |

---

## 3.4.3. Luồng xử lý chính

### Luồng đặt vé

```
[Chọn phim] → [Chọn rạp/ngày] → [Chọn suất chiếu] → [Chọn ghế]
                                                         ↓
                                                  [Giữ ghế 10 phút]
                                                         ↓
[Nhận vé QR] ← [Thanh toán VNPay] ← [Chọn combo] ← [Nhập voucher]
     ↓
[Gửi email xác nhận]
```

### Luồng check-in

```
[Khách đến rạp] → [Scan QR vé] → [Xác thực checksum] → [Check-in thành công]
                                         ↓
                              [Kiểm tra thời gian suất chiếu]
```

---

## 3.4.4. Tích hợp bên ngoài

| Dịch vụ | Mục đích |
|:--------|:---------|
| **VNPay** | Cổng thanh toán trực tuyến |
| **Google OAuth** | Đăng nhập bằng Google |
| **Gemini AI** | Chatbot hỗ trợ khách hàng |
| **SMTP** | Gửi email xác nhận, vé |
| **Redis** | Cache, rate limiting, session |

---

## 3.4.5. Bảo mật hệ thống

| Lớp bảo mật | Giải pháp |
|:------------|:----------|
| Xác thực | JWT Access/Refresh Token |
| Mã hóa | bcrypt (password), SHA-256 (QR) |
| Rate Limiting | Redis-based, IP/User tracking |
| Injection | express-mongo-sanitize, xss-clean |
| Headers | Helmet.js (CSP, HSTS) |
| Brute Force | Login attempts tracking, account lock |
