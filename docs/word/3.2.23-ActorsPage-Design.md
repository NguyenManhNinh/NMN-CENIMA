## 3.2.23. Thiết kế hệ thống – ActorsPage (Danh sách diễn viên)

### 3.2.23.1. Kiến trúc tổng thể phân hệ ActorsPage

Phân hệ ActorsPage được thiết kế theo mô hình kiến trúc web tách lớp, bao gồm ba tầng chính hoạt động độc lập và giao tiếp thông qua REST API.

**Mô hình kiến trúc và thành phần:**

- **Frontend (ReactJS):**
  - `ActorsPage.jsx`: Component chính chịu trách nhiệm render danh sách diễn viên, xử lý bộ lọc quốc tịch, sắp xếp, phân trang và tương tác like.
  - `personApi.js`: Module API client sử dụng Axios để gọi các endpoint backend.
  - **State Management**: Sử dụng React Hooks (useState, useEffect, useRef) để quản lý trạng thái local.
  - **URL State Sync**: Đồng bộ bộ lọc và phân trang với URL params thông qua `useSearchParams`.

- **Backend (Node.js/Express):**
  - `personController.js`: Controller xử lý các request liên quan đến Person.
  - `personRoutes.js`: Định nghĩa các route API.
  - **Endpoints chính:**
    - `GET /api/v1/persons/actors`: Lấy danh sách diễn viên với filter, sort, pagination.
    - `GET /api/v1/persons/nationalities`: Lấy danh sách quốc tịch unique.
    - `POST /api/v1/persons/:id/like`: Toggle like/unlike diễn viên.

- **Database (MongoDB):**
  - Collection `persons`: Lưu trữ thông tin diễn viên/đạo diễn.
  - Sử dụng Mongoose ODM với các methods: `find()`, `countDocuments()`, `distinct()`, `findByIdAndUpdate()`.
  - Index trên các trường: `role`, `isActive`, `nationality`, `viewCount`, `likeCount`.

**Sơ đồ kiến trúc:**

```
[Hình 3.x. Sơ đồ kiến trúc tổng thể phân hệ ActorsPage]
```

**Prompt vẽ sơ đồ kiến trúc (draw.io/Lucidchart):**
```
Vẽ sơ đồ kiến trúc 3 tầng cho phân hệ ActorsPage:
- Tầng 1 (Frontend): Box "ActorsPage.jsx" + "personApi.js" + "localStorage"
- Tầng 2 (Backend): Box "personRoutes.js" → "personController" với 3 methods: getActors, getNationalities, togglePersonLike
- Tầng 3 (Database): Box "MongoDB" với collection "persons"
- Mũi tên: Frontend ↔ Backend (HTTPS/REST API), Backend ↔ MongoDB (Mongoose Query)
- Sidebar: Box "movieApi.js" → "movies" collection (lấy phim đang chiếu cho sidebar)
```

---

### 3.2.23.2. Use Case Diagram – ActorsPage

**Mục đích:**
Sơ đồ Use Case mô tả các chức năng mà người dùng (Guest và User) có thể thực hiện trên trang danh sách diễn viên.

**Tác nhân tham gia:**
- **Guest**: Người dùng chưa đăng nhập
- **User**: Người dùng đã đăng nhập

**Danh sách Use Case:**

| Mã | Tên Use Case | Tác nhân | Mô tả |
|:---|:-------------|:---------|:------|
| UC-AC-01 | Xem danh sách diễn viên | Guest, User | Xem danh sách diễn viên với thông tin: avatar, tên, shortBio, viewCount, likeCount |
| UC-AC-02 | Lọc theo quốc tịch | Guest, User | Chọn quốc tịch từ dropdown để lọc danh sách |
| UC-AC-03 | Sắp xếp danh sách | Guest, User | Sắp xếp theo: phổ biến nhất, mới nhất, được thích nhất |
| UC-AC-04 | Phân trang | Guest, User | Chuyển trang, hiển thị 10 diễn viên/trang |
| UC-AC-05 | Đặt lại bộ lọc | Guest, User | Reset tất cả bộ lọc về mặc định |
| UC-AC-06 | Xem chi tiết diễn viên | Guest, User | Click vào diễn viên để xem trang chi tiết |
| UC-AC-07 | Thích diễn viên | User | Thích/bỏ thích diễn viên, cập nhật likeCount |

**Sơ đồ:**
```
[Hình 3.x. Sơ đồ Use Case Diagram – ActorsPage]
```

**Prompt vẽ Use Case Diagram (PlantUML/draw.io):**
```
Vẽ Use Case Diagram cho ActorsPage:
- Actors: Guest (bên trái), User (bên trái, kế thừa Guest)
- System boundary: "ActorsPage"
- Use Cases (7 oval):
  1. UC-AC-01: Xem danh sách diễn viên
  2. UC-AC-02: Lọc theo quốc tịch
  3. UC-AC-03: Sắp xếp danh sách
  4. UC-AC-04: Phân trang
  5. UC-AC-05: Đặt lại bộ lọc
  6. UC-AC-06: Xem chi tiết diễn viên
  7. UC-AC-07: Thích diễn viên (chỉ User)
- Guest connect đến UC-01 đến UC-06
- User connect đến UC-07
- UC-07 <<include>> UC-01
```

---

### 3.2.23.3. Activity Diagram – Luồng xem và lọc danh sách diễn viên

**Mục đích:**
Mô tả luồng xử lý khi người dùng truy cập trang, thay đổi bộ lọc và tương tác với danh sách diễn viên.

**Thành phần tham gia:**
- User (Browser)
- ActorsPage (React Component)
- personApi (API Client)
- Backend API
- MongoDB

**Mô tả luồng chính:**

1. **Bắt đầu**: User truy cập `/dien-vien`
2. **Load dữ liệu ban đầu**:
   - Gọi song song: `getActorsAPI(params)` + `getNationalitiesAPI()` + `getNowShowingMoviesAPI(5)`
   - Hiển thị loading spinner
3. **Render danh sách**: Hiển thị grid diễn viên với filter dropdown
4. **User chọn bộ lọc** (quốc tịch/sắp xếp):
   - Cập nhật state, reset trang về 1
   - Cập nhật URL params
   - Gọi lại `getActorsAPI(newParams)`
5. **User chuyển trang**:
   - Cập nhật currentPage
   - Scroll lên đầu trang
   - Gọi `getActorsAPI` với page mới
6. **User click vào diễn viên**:
   - Điều hướng đến `/dien-vien-chi-tiet/:slug`
7. **Kết thúc**

**Sơ đồ:**
```
[Hình 3.x. Sơ đồ Activity Diagram – Luồng xem và lọc danh sách diễn viên]
```

**Prompt vẽ Activity Diagram (draw.io/Lucidchart):**
```
Vẽ Activity Diagram cho ActorsPage:
- Start node → "User truy cập /dien-vien"
- Fork: 3 nhánh song song:
  (1) "Gọi getActorsAPI()"
  (2) "Gọi getNationalitiesAPI()"
  (3) "Gọi getNowShowingMoviesAPI()"
- Join → "Hiển thị loading"
- Decision: "API thành công?"
  - Yes → "Render danh sách diễn viên" + "Khởi tạo likeStates từ localStorage"
  - No → "Hiển thị lỗi/danh sách rỗng"
- "Render danh sách" → Decision: "User action?"
  - "Đổi bộ lọc" → "Reset page = 1" → "Cập nhật URL params" → Loop back to "Gọi getActorsAPI"
  - "Chuyển trang" → "Scroll top" → Loop back to "Gọi getActorsAPI"
  - "Click diễn viên" → "Navigate /dien-vien-chi-tiet/:slug" → End
  - "Click Like" → Activity Diagram riêng (3.2.23.4)
- End node
```

---

### 3.2.23.4. Sequence Diagram – Thích diễn viên (Toggle Like)

**Mục đích:**
Mô tả tương tác giữa các thành phần khi User thích/bỏ thích một diễn viên, bao gồm cơ chế optimistic update và rollback.

**Thành phần tham gia:**
- User
- ActorsPage (React)
- localStorage
- personApi.js
- Backend (personController)
- MongoDB (persons collection)

**Mô tả luồng:**

1. User click nút Like trên card diễn viên
2. ActorsPage kiểm tra `likeLoading[actorId]` → nếu đang loading thì return (chống spam)
3. Đọc trạng thái cũ từ localStorage: `prevLiked`, `prevCount`
4. **Optimistic Update**:
   - Set `likeLoading[actorId] = true`
   - Cập nhật `likeStates[actorId]` với `nextLiked`, `nextCount`
   - Lưu `localStorage.setItem(likeKey, nextLiked)`
5. Gọi API: `togglePersonLikeAPI(actorId, action)`
6. Backend nhận request, validate action ('like'/'unlike')
7. MongoDB: `Person.findByIdAndUpdate(id, { $inc: { likeCount: ±1 } })`
8. Backend trả về: `{ success: true, data: { likeCount } }`
9. **Sync với server**: Cập nhật `likeStates[actorId].likeCount` từ response
10. Set `likeLoading[actorId] = false`

**Luồng lỗi (API thất bại):**
- Rollback localStorage về `prevLiked`
- Rollback likeStates về `{ liked: prevLiked, likeCount: prevCount }`
- Set `likeLoading[actorId] = false`

**Sơ đồ:**
```
[Hình 3.x. Sơ đồ Sequence Diagram – Toggle Like diễn viên]
```

**Prompt vẽ Sequence Diagram (PlantUML/draw.io):**
```
Vẽ Sequence Diagram cho Toggle Like:

Participants (trái → phải): User, ActorsPage, localStorage, personApi, Backend, MongoDB

1. User → ActorsPage: click Like button
2. ActorsPage → ActorsPage: check likeLoading[actorId] (if true → return)
3. ActorsPage → localStorage: getItem("actor_liked_{id}")
4. localStorage → ActorsPage: prevLiked (true/false)
5. ActorsPage → ActorsPage: setLikeLoading[actorId] = true
6. ActorsPage → ActorsPage: optimistic update likeStates (UI)
7. ActorsPage → localStorage: setItem("actor_liked_{id}", nextLiked)
8. ActorsPage → personApi: togglePersonLikeAPI(actorId, action)
9. personApi → Backend: POST /api/v1/persons/:id/like {action}
10. Backend → MongoDB: findByIdAndUpdate($inc: {likeCount: ±1})
11. MongoDB → Backend: updated person
12. Backend → personApi: {success, data: {likeCount}}
13. personApi → ActorsPage: response

Alt [API Success]:
  14. ActorsPage → ActorsPage: sync likeCount from server
  15. ActorsPage → ActorsPage: setLikeLoading[actorId] = false

Alt [API Error]:
  14. ActorsPage → localStorage: rollback setItem(prevLiked)
  15. ActorsPage → ActorsPage: rollback likeStates
  16. ActorsPage → ActorsPage: setLikeLoading[actorId] = false
```

---

### 3.2.23.5. Class Diagram rút gọn – ActorsPage

**Mục đích:**
Mô tả cấu trúc các lớp và mối quan hệ giữa chúng trong phân hệ ActorsPage, bao gồm Frontend components, API client và Backend layers.

**Phạm vi:**
- Frontend: ActorsPage component, personApi module
- Backend: PersonController, PersonService (implicit), Person model
- Mối quan hệ: Dependency, Association

**Các lớp chính:**

**Frontend Layer:**
```
┌──────────────────────────────────────────┐
│            ActorsPage                    │
├──────────────────────────────────────────┤
│ - actors: Actor[]                        │
│ - nationalityOptions: Option[]           │
│ - selectedNationality: string            │
│ - selectedSort: string                   │
│ - currentPage: number                    │
│ - totalPages: number                     │
│ - likeStates: Record<string, LikeState>  │
│ - likeLoading: Record<string, boolean>   │
│ - loading: boolean                       │
├──────────────────────────────────────────┤
│ + useEffect(): void                      │
│ + handleToggleLike(actorId, e): void     │
│ + handleActorClick(slug): void           │
│ + handlePageChange(page): void           │
│ + resetFilters(): void                   │
└──────────────────────────────────────────┘
          │ uses
          ▼
┌──────────────────────────────────────────┐
│            personApi                     │
├──────────────────────────────────────────┤
│ + getActorsAPI(params): Promise          │
│ + getNationalitiesAPI(): Promise         │
│ + togglePersonLikeAPI(id, action): Promise│
└──────────────────────────────────────────┘
```

**Backend Layer:**
```
┌──────────────────────────────────────────┐
│         PersonController                 │
├──────────────────────────────────────────┤
│ + getActors(req, res): void              │
│ + getNationalities(req, res): void       │
│ + togglePersonLike(req, res): void       │
└──────────────────────────────────────────┘
          │ uses
          ▼
┌──────────────────────────────────────────┐
│            Person (Model)                │
├──────────────────────────────────────────┤
│ - _id: ObjectId                          │
│ - name: string                           │
│ - slug: string                           │
│ - photoUrl: string                       │
│ - shortBio: string                       │
│ - nationality: string                    │
│ - role: enum ['actor','director','both'] │
│ - viewCount: number                      │
│ - likeCount: number                      │
│ - isActive: boolean                      │
├──────────────────────────────────────────┤
│ + find(filter): Query                    │
│ + countDocuments(filter): Promise        │
│ + distinct(field): Promise               │
│ + findByIdAndUpdate(id, update): Promise │
└──────────────────────────────────────────┘
```

**Mối quan hệ:**
- ActorsPage **depends on** personApi
- personApi **calls** PersonController (via HTTP)
- PersonController **uses** Person model
- Person **persisted in** MongoDB (persons collection)

**Sơ đồ:**
```
[Hình 3.x. Sơ đồ Class Diagram rút gọn – ActorsPage]
```

**Prompt vẽ Class Diagram (draw.io/Lucidchart):**
```
Vẽ Class Diagram với 2 package:

Package "Frontend":
- Class "ActorsPage" với attributes: actors, nationalityOptions, selectedNationality, selectedSort, currentPage, likeStates, likeLoading, loading
  Methods: handleToggleLike(), handleActorClick(), handlePageChange(), resetFilters()
- Class "personApi" với methods: getActorsAPI(), getNationalitiesAPI(), togglePersonLikeAPI()
- ActorsPage -----uses-----> personApi

Package "Backend":
- Class "PersonController" với methods: getActors(), getNationalities(), togglePersonLike()
- Class "Person" (entity) với attributes: _id, name, slug, photoUrl, shortBio, nationality, role, viewCount, likeCount, isActive
  Methods: find(), countDocuments(), distinct(), findByIdAndUpdate()
- PersonController -----uses-----> Person

Cross-package:
- personApi .....HTTP REST.....> PersonController (dashed line)
```

---

*Các sơ đồ trên cần được vẽ bằng công cụ như draw.io, Lucidchart hoặc PlantUML và chèn vào báo cáo Word tại các vị trí đã đánh dấu [Hình 3.x].*
