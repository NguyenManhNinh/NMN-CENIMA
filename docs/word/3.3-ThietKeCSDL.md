# 3.3. Thiết kế cơ sở dữ liệu

Hệ thống sử dụng cơ sở dữ liệu **MongoDB** với mô hình document-oriented. Dưới đây là mô tả các collection chính:

## 3.3.1. Danh sách các Collection

| STT | Collection | Mô tả |
|:---:|:-----------|:------|
| 1 | User | Thông tin người dùng, xác thực, phân quyền |
| 2 | Movie | Thông tin phim, đạo diễn, diễn viên, thể loại |
| 3 | Genre | Thể loại phim |
| 4 | Person | Đạo diễn, diễn viên |
| 5 | Cinema | Thông tin cụm rạp chiếu phim |
| 6 | Room | Phòng chiếu và sơ đồ ghế |
| 7 | Showtime | Suất chiếu phim |
| 8 | Order | Đơn đặt vé |
| 9 | Ticket | Vé điện tử |
| 10 | Payment | Giao dịch thanh toán VNPay |
| 11 | Review | Bình luận, đánh giá phim |
| 12 | Voucher | Mã giảm giá |
| 13 | UserVoucher | Ví voucher của người dùng |
| 14 | Combo | Bắp nước đi kèm |
| 15 | SeatHold | Giữ ghế tạm thời |

---

## 3.3.2. Mô tả chi tiết các Collection chính

### 1. User (Người dùng)

| Trường | Kiểu dữ liệu | Mô tả |
|:-------|:-------------|:------|
| _id | ObjectId | Khóa chính |
| name | String | Họ tên |
| email | String | Email (unique) |
| password | String | Mật khẩu đã hash |
| phone | String | Số điện thoại |
| role | Enum | Vai trò: user, staff, manager, admin |
| authType | Enum | Phương thức đăng nhập: local, google |
| points | Number | Điểm thưởng tích lũy |
| rank | Enum | Hạng thành viên: MEMBER, VIP, VVIP |
| isActive | Boolean | Trạng thái kích hoạt |
| avatar | String | URL ảnh đại diện |
| createdAt | Date | Thời gian tạo |

---

### 2. Movie (Phim)

| Trường | Kiểu dữ liệu | Mô tả |
|:-------|:-------------|:------|
| _id | ObjectId | Khóa chính |
| title | String | Tên phim (unique) |
| slug | String | URL-friendly slug |
| description | String | Mô tả nội dung |
| director | ObjectId | Tham chiếu đến Person |
| actors | [ObjectId] | Danh sách diễn viên |
| genres | [ObjectId] | Danh sách thể loại |
| duration | Number | Thời lượng (phút) |
| ageRating | Enum | Phân loại: P, C13, C16, C18 |
| posterUrl | String | URL poster |
| trailerUrl | String | URL trailer YouTube |
| releaseDate | Date | Ngày khởi chiếu |
| status | Enum | Trạng thái: NOW, COMING, STOP |
| rating | Number | Điểm đánh giá (0-10) |
| viewCount | Number | Lượt xem |
| likeCount | Number | Lượt thích |

---

### 3. Cinema (Rạp)

| Trường | Kiểu dữ liệu | Mô tả |
|:-------|:-------------|:------|
| _id | ObjectId | Khóa chính |
| name | String | Tên rạp (unique) |
| address | String | Địa chỉ |
| city | String | Thành phố |
| phone | String | Số hotline |
| status | Enum | OPEN, CLOSED, MAINTENANCE |

---

### 4. Room (Phòng chiếu)

| Trường | Kiểu dữ liệu | Mô tả |
|:-------|:-------------|:------|
| _id | ObjectId | Khóa chính |
| cinemaId | ObjectId | Tham chiếu đến Cinema |
| name | String | Tên phòng (P01, P02...) |
| type | Enum | Loại phòng: 2D, 3D, IMAX |
| totalSeats | Number | Tổng số ghế |
| seatMap | Array | Ma trận sơ đồ ghế |
| status | Enum | ACTIVE, MAINTENANCE |

**Cấu trúc seatMap:**
```json
[
  {
    "row": "A",
    "seats": [
      { "number": 1, "type": "standard" },
      { "number": 2, "type": "vip" }
    ]
  }
]
```

---

### 5. Showtime (Suất chiếu)

| Trường | Kiểu dữ liệu | Mô tả |
|:-------|:-------------|:------|
| _id | ObjectId | Khóa chính |
| movieId | ObjectId | Tham chiếu đến Movie |
| cinemaId | ObjectId | Tham chiếu đến Cinema |
| roomId | ObjectId | Tham chiếu đến Room |
| startAt | Date | Thời gian bắt đầu |
| endAt | Date | Thời gian kết thúc |
| basePrice | Number | Giá vé cơ bản |
| format | Enum | Định dạng: 2D, 3D, IMAX |
| subtitle | Enum | Phụ đề, Lồng tiếng |
| status | Enum | OPEN, CLOSED, CANCELED |

**Ràng buộc:** Index unique `(roomId, startAt)` để chống xung đột suất chiếu.

---

### 6. Order (Đơn hàng)

| Trường | Kiểu dữ liệu | Mô tả |
|:-------|:-------------|:------|
| _id | ObjectId | Khóa chính |
| orderNo | String | Mã đơn hàng (unique) |
| userId | ObjectId | Tham chiếu đến User |
| showtimeId | ObjectId | Tham chiếu đến Showtime |
| seats | Array | Snapshot ghế đã đặt |
| combos | Array | Snapshot combo đi kèm |
| subTotal | Number | Tổng tiền trước giảm |
| discount | Number | Số tiền giảm giá |
| totalAmount | Number | Tổng tiền thanh toán |
| voucherCode | String | Mã voucher đã dùng |
| status | Enum | PENDING, PROCESSING, PAID, FAILED, CANCELLED |

---

### 7. Ticket (Vé)

| Trường | Kiểu dữ liệu | Mô tả |
|:-------|:-------------|:------|
| _id | ObjectId | Khóa chính |
| orderId | ObjectId | Tham chiếu đến Order |
| userId | ObjectId | Tham chiếu đến User |
| showtimeId | ObjectId | Tham chiếu đến Showtime |
| seatCode | String | Mã ghế (A1, B2...) |
| ticketCode | String | Mã vé hiển thị |
| qrChecksum | String | Hash xác thực QR |
| status | Enum | VALID, USED, VOID |
| issuedAt | Date | Thời gian xuất vé |
| usedAt | Date | Thời gian soát vé |

**Ràng buộc:** Index unique `(showtimeId, seatCode)` để chống bán trùng vé.

---

### 8. Payment (Thanh toán)

| Trường | Kiểu dữ liệu | Mô tả |
|:-------|:-------------|:------|
| _id | ObjectId | Khóa chính |
| orderId | ObjectId | Tham chiếu đến Order |
| gateway | Enum | Cổng thanh toán: VNPAY |
| txnRef | String | Mã giao dịch (unique) |
| bankTranNo | String | Mã giao dịch ngân hàng |
| amount | Number | Số tiền |
| state | Enum | PENDING, SUCCESS, FAIL |
| rawPayload | Mixed | Dữ liệu IPN gốc từ VNPay |

---

## 3.3.3. Sơ đồ quan hệ giữa các Collection

```
┌─────────┐     ┌─────────┐     ┌─────────┐
│  User   │────<│  Order  │>────│Showtime │
└─────────┘     └─────────┘     └─────────┘
     │               │               │
     │               ▼               │
     │          ┌─────────┐          │
     └─────────>│ Ticket  │<─────────┘
                └─────────┘

┌─────────┐     ┌─────────┐     ┌─────────┐
│ Cinema  │────<│  Room   │>────│Showtime │
└─────────┘     └─────────┘     └─────────┘
                                     │
                                     ▼
                                ┌─────────┐
                                │  Movie  │
                                └─────────┘
                                     │
              ┌──────────────────────┼──────────────────────┐
              ▼                      ▼                      ▼
         ┌─────────┐            ┌─────────┐            ┌─────────┐
         │ Person  │            │  Genre  │            │ Review  │
         └─────────┘            └─────────┘            └─────────┘
```

---

## 3.3.4. Các ràng buộc toàn vẹn chính

1. **User.email**: Unique, định dạng email hợp lệ
2. **Movie.title**: Unique, không trùng tên phim
3. **Room**: Compound index `(cinemaId, name)` đảm bảo tên phòng unique trong rạp
4. **Showtime**: Compound index `(roomId, startAt)` chống xung đột suất chiếu
5. **Ticket**: Compound index `(showtimeId, seatCode)` chống bán trùng vé
6. **Payment.txnRef**: Unique, đảm bảo idempotent khi VNPay callback
