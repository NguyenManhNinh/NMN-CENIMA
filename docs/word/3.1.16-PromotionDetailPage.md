## 3.1.16. Phân tích yêu cầu phân hệ 13: Chi tiết ưu đãi (PromotionDetailPage)

### 3.1.16.1. Mục tiêu và phạm vi phân hệ

Phân hệ PromotionDetailPage là trang hiển thị thông tin chi tiết của một chương trình ưu đãi, bao gồm nội dung HTML đầy đủ, thông tin thời gian hiệu lực, điều kiện áp dụng và chức năng nhận voucher. Trang này cho phép người dùng đọc chi tiết ưu đãi, kiểm tra trạng thái nhận (claimState) và thực hiện hành động nhận voucher hoặc mã QR tùy theo loại ưu đãi.

Phạm vi phân hệ bao gồm:
- Hiển thị thông tin chi tiết ưu đãi (tiêu đề, nội dung HTML, ảnh cover, thời gian, ghi chú)
- Hiển thị trạng thái nhận voucher (claimState): ELIGIBLE, ALREADY_CLAIMED, EXPIRED, NOT_LOGGED_IN...
- Chức năng nhận voucher online (ONLINE_VOUCHER) - tạo UserVoucher
- Chức năng nhận mã QR offline (OFFLINE_ONLY + QR_REDEEM) - tạo PromotionRedeem token
- Hiển thị thông tin voucher đã nhận hoặc mã QR
- Tương tác thích/bỏ thích ưu đãi
- Tăng lượt xem với cơ chế cooldown 24 giờ qua Redis
- Breadcrumb điều hướng

### 3.1.16.2. Tác nhân và quyền hạn

| Tác nhân | Quyền hạn |
|:---------|:----------|
| Guest (khách) | Xem nội dung ưu đãi, xem thời gian hiệu lực, thích ưu đãi (tracked by IP) |
| User (thành viên) | Tất cả quyền của Guest + nhận voucher/mã QR, xem thông tin voucher đã nhận |
| Staff (nhân viên) | Quét mã QR để xác nhận sử dụng ưu đãi tại quầy |

### 3.1.16.3. Yêu cầu chức năng (FR) – PromotionDetailPage

| ID | Yêu cầu | Mô tả | Ưu tiên |
|:---|:--------|:------|:--------|
| FR-PD-01 | Hiển thị thông tin ưu đãi | Hiển thị title, coverUrl, content (HTML), startAt, endAt, notes | Cao |
| FR-PD-02 | Hiển thị trạng thái nhận | Hiển thị claimState: ELIGIBLE, ALREADY_CLAIMED, EXPIRED, NOT_STARTED, QUOTA_EXHAUSTED, NOT_LOGGED_IN | Cao |
| FR-PD-03 | Nhận voucher online | Nút "Nhận ngay" gọi API POST /promotions/:id/claim để tạo UserVoucher (applyMode = ONLINE_VOUCHER) | Cao |
| FR-PD-04 | Nhận mã QR offline | Nút "Lấy mã" gọi API POST /promotions/:id/offline-claim để tạo PromotionRedeem token (applyMode = OFFLINE_ONLY, offlineMode = QR_REDEEM) | Cao |
| FR-PD-05 | Hiển thị voucher đã nhận | Hiển thị mã voucher, số lượng, số lần đã dùng, ngày hết hạn | Cao |
| FR-PD-06 | Hiển thị mã QR | Hiển thị token và QR code để đưa cho nhân viên quét | Cao |
| FR-PD-07 | Thích ưu đãi | Toggle like với số lượt thích, hỗ trợ cả user đăng nhập và guest (theo IP) | Trung bình |
| FR-PD-08 | Tăng lượt xem | Tự động tăng viewCount khi truy cập, cooldown 24h per viewer (userId hoặc IP) | Trung bình |
| FR-PD-09 | Breadcrumb | Hiển thị đường dẫn: Trang chủ > Ưu đãi > [Tên ưu đãi] | Cao |
| FR-PD-10 | Hiển thị quota còn lại | Hiển thị số lượt còn lại (remainingRedeems) nếu có giới hạn totalRedeemsLimit | Trung bình |
| FR-PD-11 | Kiểm tra rank thành viên | Hiển thị thông báo nếu ưu đãi chỉ dành cho hạng VIP/VVIP | Trung bình |
| FR-PD-12 | Loading State | Skeleton loading khi tải dữ liệu | Cao |
| FR-PD-13 | Xử lý 404 | Hiển thị trang 404 nếu không tìm thấy ưu đãi | Cao |

### 3.1.16.4. Yêu cầu phi chức năng (NFR)

| ID | Yêu cầu | Mô tả |
|:---|:--------|:------|
| NFR-PD-01 | Hiệu năng | Trang load < 3 giây, API response < 500ms |
| NFR-PD-02 | Bảo mật | JWT authentication cho claim API, chống spam với quota check |
| NFR-PD-03 | Responsive | Layout thích ứng desktop/tablet/mobile |
| NFR-PD-04 | Idempotent | API claim trả về 200 với voucher cũ nếu đã claim, không tạo trùng |
| NFR-PD-05 | Atomic | Quota được trừ atomic với $inc và condition check để tránh race condition |
| NFR-PD-06 | SEO | Title và meta description động theo ưu đãi |

### 3.1.16.5. Quy tắc nghiệp vụ

- **BR-PD-01 (Kiểm tra thời gian):** Nếu now < startAt → claimState = 'NOT_STARTED'. Nếu now > endAt → claimState = 'EXPIRED'. Nếu status !== 'ACTIVE' → claimState = 'INACTIVE'.

- **BR-PD-02 (Kiểm tra đăng nhập):** Nếu user chưa đăng nhập → claimState = 'NOT_LOGGED_IN', hiển thị nút "Đăng nhập để nhận".

- **BR-PD-03 (Kiểm tra đã claim):** Hệ thống check UserVoucher (ONLINE_VOUCHER) hoặc PromotionRedeem (OFFLINE_ONLY) với status ACTIVE/ISSUED. Nếu đã có → claimState = 'ALREADY_CLAIMED'.

- **BR-PD-04 (Kiểm tra quota):** Nếu totalRedeemsLimit !== null và redeemCount >= totalRedeemsLimit → claimState = 'QUOTA_EXHAUSTED'.

- **BR-PD-05 (Kiểm tra rank):** Nếu allowedUserRanks có giá trị và user.rank không nằm trong danh sách → trả lỗi 403 với message thông báo.

- **BR-PD-06 (Idempotent claim):** Nếu user đã claim, API trả về 200 với alreadyClaimed = true và thông tin voucher/token cũ thay vì tạo mới.

- **BR-PD-07 (Atomic quota OFFLINE_ONLY):** Sử dụng MongoDB transaction với incRedeemCountOrFail() để tăng redeemCount atomic, đảm bảo không vượt quota khi có nhiều request đồng thời.

- **BR-PD-08 (Race condition protection):** Unique index trên (promotionId, userId, status='ISSUED') trong PromotionRedeem. Nếu duplicate key error → fetch lại và trả về token cũ.

- **BR-PD-09 (View cooldown 24h):** Sử dụng Redis key `promo_view:{promotionId}:{viewerId}` với TTL 24h để tránh tăng view spam.

- **BR-PD-10 (INFO_ONLY mode):** Nếu applyMode = 'OFFLINE_ONLY' và offlineMode = 'INFO_ONLY' → không cần mã, chỉ hiển thị hướng dẫn đến quầy.

- **BR-PD-11 (Like tracking):** User đăng nhập: lưu userId vào likedBy array. Guest: lưu IP vào likedByIPs array để track.

---

*Phần phân tích yêu cầu trên đây là cơ sở để thiết kế kiến trúc hệ thống, sơ đồ Use Case, Activity Diagram, Sequence Diagram và Class Diagram trong mục 3.2 tiếp theo.*
