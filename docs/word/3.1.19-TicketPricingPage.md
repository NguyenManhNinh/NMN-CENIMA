## 3.1.19. Phân tích yêu cầu phân hệ 16: Giá Vé (TicketPricingPage)

### 3.1.19.1. Mục tiêu và phạm vi phân hệ

Phân hệ TicketPricingPage là trang hiển thị bảng giá vé của rạp NMN Cinema, cung cấp cho người dùng thông tin giá vé theo từng loại hình chiếu (2D, 3D, ngày lễ). Đây là chức năng công khai thông tin dịch vụ theo yêu cầu minh bạch hóa của Nghị định 52/2013/NĐ-CP, giúp khách hàng nắm rõ mức giá trước khi thực hiện giao dịch đặt vé.

Phạm vi phân hệ bao gồm:
- Hiển thị bảng giá vé theo dạng tabs, mỗi tab tương ứng một loại giá (Giá vé 2D, Giá vé 3D, Ngày Lễ…)
- Ảnh bảng giá hiển thị toàn bộ chi tiết giá vé dưới dạng hình ảnh (aspect ratio 16:9)
- Hỗ trợ URL hash để deep link đến tab cụ thể (VD: /gia-ve#3D-price)
- Khu vực ghi chú bổ sung (HTML content) hiển thị các điều kiện áp dụng
- Loading overlay toàn màn hình với logo NMN Cinema
- Xử lý lỗi API và lỗi tải ảnh với fallback message
- Chống hotlink ảnh bằng referrerPolicy="no-referrer"
- Quản trị viên có thể cập nhật bảng giá thông qua API Admin

### 3.1.19.2. Tác nhân và quyền hạn

| Tác nhân | Quyền hạn |
|:---------|:----------|
| Guest (khách) | Xem bảng giá vé, chuyển đổi giữa các tab giá, xem ghi chú điều kiện áp dụng |
| User (thành viên) | Tất cả quyền của Guest (trang giá vé là trang công khai, không phân biệt quyền) |
| Admin (quản trị) | Cập nhật/tạo mới bảng giá vé, quản lý danh sách tabs và ghi chú, xem tất cả bảng giá (bao gồm bản nháp) |

### 3.1.19.3. Yêu cầu chức năng (FR) – TicketPricingPage

| ID | Yêu cầu | Mô tả | Ưu tiên |
|:---|:--------|:------|:--------|
| FR-TP-01 | Hiển thị tiêu đề bảng giá | Render tiêu đề bảng giá từ API (VD: "Giá Vé rạp NMN Cinema - Hà Nội") | Cao |
| FR-TP-02 | Hiển thị danh sách tabs | Render danh sách tabs giá vé dạng button, tab active có nền vàng, tab inactive có viền trắng mờ | Cao |
| FR-TP-03 | Chuyển đổi tab | Click tab để chuyển đổi hiển thị ảnh bảng giá tương ứng | Cao |
| FR-TP-04 | Hiển thị ảnh bảng giá | Hiển thị ảnh bảng giá chi tiết theo tab đang chọn, aspect ratio 16:9 | Cao |
| FR-TP-05 | URL hash routing | Đồng bộ tab đang chọn với URL hash (VD: /gia-ve#3D-price), hỗ trợ deep link và chia sẻ | Cao |
| FR-TP-06 | Hiển thị ghi chú | Render nội dung ghi chú (HTML content) bên dưới ảnh bảng giá | Cao |
| FR-TP-07 | Loading state | Hiển thị loading overlay toàn màn hình với logo NMN Cinema khi tải dữ liệu | Cao |
| FR-TP-08 | Xử lý lỗi API | Hiển thị thông báo lỗi với nút "Thử lại" khi API không phản hồi | Cao |
| FR-TP-09 | Xử lý ảnh lỗi | Hiển thị fallback "Ảnh đang được cập nhật" khi ảnh bảng giá không tải được | Cao |
| FR-TP-10 | Skeleton loading ảnh | Hiển thị skeleton animation khi ảnh đang tải, chuyển opacity mượt khi ảnh sẵn sàng | Trung bình |
| FR-TP-11 | Xử lý trạng thái trống | Hiển thị thông báo "Chưa có dữ liệu bảng giá" khi API trả về 404 | Cao |
| FR-TP-12 | Cập nhật bảng giá (Admin) | API PUT cho phép Admin cập nhật tiêu đề, tabs, ghi chú của bảng giá | Cao |
| FR-TP-13 | Xem tất cả bảng giá (Admin) | API GET cho Admin xem danh sách tất cả bảng giá bao gồm bản nháp | Trung bình |

### 3.1.19.4. Yêu cầu phi chức năng (NFR)

| ID | Yêu cầu | Mô tả |
|:---|:--------|:------|
| NFR-TP-01 | Hiệu năng | Trang load < 3 giây, API response < 500ms, ảnh lazy load với skeleton |
| NFR-TP-02 | Responsive | Hỗ trợ desktop và mobile, tabs tự động xuống dòng (flex-wrap) trên màn hình nhỏ |
| NFR-TP-03 | Bảo mật | API Admin yêu cầu JWT + role admin, chống hotlink ảnh bằng referrerPolicy |
| NFR-TP-04 | Tương thích | Hoạt động tốt trên Chrome, Firefox, Safari, Edge phiên bản mới nhất |
| NFR-TP-05 | Khả dụng | Có fallback cho mọi trạng thái: loading, lỗi API, lỗi ảnh, dữ liệu trống |
| NFR-TP-06 | Trải nghiệm | Chuyển đổi tab mượt với opacity transition 0.3s, không reload trang |

### 3.1.19.5. Quy tắc nghiệp vụ

- **BR-TP-01 (Chỉ hiển thị bảng giá active):** Frontend gọi API GET lấy bảng giá có status = 'active'. Hệ thống đảm bảo tại mọi thời điểm chỉ có tối đa 1 bảng giá ở trạng thái active.

- **BR-TP-02 (Single-active enforcement):** Khi Admin lưu bảng giá mới với status = 'active', pre-save hook tự động chuyển tất cả bảng giá khác sang trạng thái 'draft' để đảm bảo ràng buộc single-active.

- **BR-TP-03 (Tabs sắp xếp theo sortOrder):** Danh sách tabs được sắp xếp theo trường sortOrder tăng dần ở phía backend trước khi trả về cho frontend, đảm bảo thứ tự hiển thị nhất quán.

- **BR-TP-04 (URL hash đồng bộ):** Khi người dùng chọn tab, URL hash được cập nhật tương ứng (VD: #2D-price). Khi truy cập URL có hash, hệ thống tự đồng tìm tab có slug khớp và kích hoạt tab đó.

- **BR-TP-05 (Slug phân biệt hoa thường):** Slug của tab giữ nguyên chữ hoa/thường (VD: "2D-price", "3D-price") để đảm bảo khớp chính xác với URL hash.

- **BR-TP-06 (Fallback ảnh):** Khi ảnh bảng giá không tải được (lỗi hotlink, URL hết hạn), hệ thống hiển thị placeholder "Ảnh đang được cập nhật" thay vì để trống hoặc hiển thị icon broken image.

- **BR-TP-07 (Validate tabs tối thiểu):** Khi Admin cập nhật bảng giá, backend validate mảng tabs phải có ít nhất 1 phần tử. Nếu không đạt, trả về lỗi 400.

- **BR-TP-08 (Notes HTML content):** Ghi chú được lưu dưới dạng HTML và render bằng dangerouslySetInnerHTML. Nội dung HTML cần được kiểm soát từ phía Admin để tránh XSS.

---

*Phần phân tích yêu cầu trên đây là cơ sở để thiết kế kiến trúc hệ thống, sơ đồ Use Case, Activity Diagram, Sequence Diagram và Class Diagram trong mục 3.2 tiếp theo.*
