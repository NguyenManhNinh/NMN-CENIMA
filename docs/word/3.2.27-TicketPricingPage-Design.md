## 3.2.27. Thiết kế hệ thống – Giá Vé (TicketPricingPage)

### 3.2.27.1. Kiến trúc tổng thể phân hệ giá vé

Phân hệ giá vé được thiết kế theo mô hình kiến trúc web tách lớp,gồm ba tầng chính hoạt động độc lập và giao tiếp thông qua REST API.

Mô hình kiến trúc và thành phần:
Frontend:
•	`TicketPricingPage.jsx`:Component chính chịu trách nhiệm render bảng giá vé với hệ thống tabs,hiển thị ảnh bảng giá theo tab đang chọn và render ghi chú HTML.
•	`ticketPricingApi.js`:Module API client sử dụng Axios instance riêng để gọi các endpoint backend.
•	State Management:Sử dụng React hooks (useState,useEffect) để quản lý 5 trạng thái:pricingData,activeTab,loading,error,imageLoading,imageError.
•	URL Hash Sync:Đồng bộ tab đang chọn với URL hash thông qua useLocation và useNavigate từ React Router.

Backend:
•	`ticketPricingController.js`:Controller xử lý 3 endpoint: lấy bảng giá active (Public), cập nhật bảng giá (Admin), lấy tất cả bảng giá (Admin).
•	`ticketPricingRoutes.js`:Định nghĩa các route API,phân quyền Public/Admin qua middleware protect + restrictTo('admin').

Database:
•	Collection `ticketpricings`:Lưu trữ bảng giá vé với sub-document tabs (nhúng).
•	Schema áp dụng pre-save hook để đảm bảo ràng buộc single-active.
•	Index trên trường `status` để tối ưu truy vấn lấy bảng giá active.

Hình 3.xx – Sơ đồ kiến trúc tổng thể phân hệ giá vé

### 3.2.27.2. Use Case Diagram – Giá Vé

Sơ đồ Use Case mô tả các tác nhân và chức năng của phân hệ giá vé:

Tác nhân:
•	Guest/User:Xem bảng giá vé → Chuyển đổi tab giá → Xem ghi chú điều kiện.
•	Admin:Cập nhật bảng giá vé → Quản lý tabs → Chỉnh sửa ghi chú → Xem tất cả bảng giá.

Các Use Case chính:
•	UC-TP-01:Xem bảng giá vé (Primary – Guest/User)
Mô tả:Người dùng truy cập trang /gia-ve,hệ thống gọi API lấy bảng giá active và hiển thị tab đầu tiên với ảnh bảng giá tương ứng.
•	UC-TP-02:Chuyển đổi tab giá (Guest/User)
Mô tả:Người dùng click vào tab khác (VD: "GIÁ VÉ 3D"),hệ thống cập nhật ảnh bảng giá và URL hash.
•	UC-TP-03:Truy cập deep link (Guest/User)
Mô tả:Người dùng truy cập URL có hash (VD: /gia-ve#3D-price),hệ thống tự động kích hoạt tab tương ứng.
•	UC-TP-04:Cập nhật bảng giá (Admin)
Mô tả:Admin gửi request PUT với thông tin bảng giá mới,backend validate và lưu vào database.
•	UC-TP-05:Xem tất cả bảng giá (Admin)
Mô tả:Admin xem danh sách tất cả bảng giá (bao gồm draft) để quản lý.

Hình 3.xx. Sơ đồ Use Case Diagram – Phân hệ Giá Vé

### 3.2.27.3. Activity Diagram – Luồng xem bảng giá vé

Sơ đồ Activity mô tả luồng xử lý khi người dùng truy cập trang giá vé:

1.Người dùng truy cập trang /gia-ve
2.Hệ thống hiển thị Loading overlay (logo NMN Cinema + spinner)
3.Frontend gọi API GET /api/v1/ticket-pricing
4.[Phân nhánh] API response:
  a.Thành công (200):
    - Lưu dữ liệu bảng giá vào state
    - Kiểm tra URL hash:
      + Có hash → Tìm tab có slug khớp → Kích hoạt tab đó
      + Không có hash → Kích hoạt tab đầu tiên (index 0)
    - Hiển thị ảnh bảng giá + skeleton loading
    - Ảnh tải thành công → Ẩn skeleton,hiển thị ảnh với opacity transition
    - Ảnh tải thất bại → Hiển thị fallback "Ảnh đang được cập nhật"
    - Hiển thị ghi chú HTML bên dưới ảnh
  b.404 (chưa có bảng giá):
    - Hiển thị thông báo "Chưa có dữ liệu bảng giá"
  c.Lỗi khác (500/timeout):
    - Hiển thị thông báo lỗi + nút "Thử lại"
5.[Tương tác] Người dùng click tab khác:
  - Reset trạng thái ảnh (imageLoading=true,imageError=false)
  - Cập nhật activeTab
  - Cập nhật URL hash bằng navigate(/gia-ve#slug,{replace:true})
  - Load ảnh mới theo tab được chọn
6.Kết thúc

Hình 3.xx. Sơ đồ Activity Diagram – Luồng xem bảng giá vé

### 3.2.27.4. Sequence Diagram – Tải và hiển thị bảng giá

Sơ đồ Sequence mô tả tương tác giữa các thành phần khi tải trang giá vé:

Các đối tượng tham gia:
•	User (Browser)
•	TicketPricingPage (React Component)
•	ticketPricingApi (Axios Client)
•	TicketPricingController (Backend)
•	TicketPricing (MongoDB Model)

Luồng tương tác:
1.User → TicketPricingPage:Truy cập /gia-ve
2.TicketPricingPage:setState(loading=true)
3.TicketPricingPage → ticketPricingApi:getTicketPricingAPI()
4.ticketPricingApi → TicketPricingController:GET /api/v1/ticket-pricing
5.TicketPricingController → TicketPricing:findOne({status:'active'}).lean()
6.TicketPricing → TicketPricingController:pricing document (hoặc null)
7.[alt] pricing tồn tại:
  a.TicketPricingController:Sort tabs by sortOrder
  b.TicketPricingController → ticketPricingApi:200 {success:true,data:pricing}
  c.ticketPricingApi → TicketPricingPage:response.data
  d.TicketPricingPage:setState(pricingData=data,loading=false)
  e.TicketPricingPage:Kiểm tra location.hash → setActiveTab
  f.TicketPricingPage → User:Render tabs + ảnh bảng giá + ghi chú
8.[alt] pricing = null:
  a.TicketPricingController → ticketPricingApi:404 {success:false}
  b.TicketPricingPage:setState(pricingData=null,loading=false)
  c.TicketPricingPage → User:Hiển thị "Chưa có dữ liệu bảng giá"

Hình 3.xx. Sơ đồ Sequence Diagram – Tải và hiển thị bảng giá vé

### 3.2.27.5. Sequence Diagram – Admin cập nhật bảng giá

Sơ đồ Sequence mô tả luồng Admin cập nhật bảng giá vé:

Các đối tượng tham gia:
•	Admin (Browser)
•	AdminPanel (React Component)
•	TicketPricingController (Backend)
•	authMiddleware (JWT + Role Check)
•	TicketPricing (MongoDB Model)

Luồng tương tác:
1.Admin → AdminPanel:Nhập thông tin bảng giá mới (title,tabs[],notes)
2.AdminPanel → TicketPricingController:PUT /api/v1/ticket-pricing (Bearer token)
3.TicketPricingController → authMiddleware:Verify JWT + check role='admin'
4.[alt] Unauthorized:
  a.authMiddleware → AdminPanel:401/403
5.TicketPricingController:Validate tabs (phải là mảng,length > 0)
6.[alt] Validation fail:
  a.TicketPricingController → AdminPanel:400 "Phải có ít nhất 1 tab giá"
7.TicketPricingController → TicketPricing:findOne({status:'active'})
8.[alt] Đã có bảng giá active:
  a.TicketPricingController:Cập nhật title,tabs,notes,status
  b.TicketPricing:pre-save hook → updateMany({status:'draft'}) cho các bảng giá khác
  c.TicketPricing:save()
9.[alt] Chưa có bảng giá nào:
  a.TicketPricingController → TicketPricing:create({title,tabs,notes,status:'active'})
  b.TicketPricing:pre-save hook (không có bảng khác để chuyển draft)
10.TicketPricingController → AdminPanel:200 {success:true,data:pricing}

Hình 3.xx. Sơ đồ Sequence Diagram – Admin cập nhật bảng giá vé

### 3.2.27.6. Class Diagram rút gọn – Giá Vé

Mục đích:
Mô tả cấu trúc các lớp và mối quan hệ giữa chúng trong phân hệ TicketPricingPage,bao gồm frontend components,API client và backend layers.

Phạm vi:
•	Frontend:TicketPricingPage component,ticketPricingApi module
•	Backend:TicketPricingController,TicketPricing Model (với embedded TicketPricingTab)
•	Middleware:authMiddleware (protect + restrictTo)
•	Mối quan hệ:Dependency,Composition (tabs embedded trong pricing)

Các lớp chính:

**Frontend Layer:**

| Lớp | Thuộc tính | Phương thức |
|:----|:-----------|:------------|
| TicketPricingPage | -pricingData:Object, -activeTab:Number, -loading:Boolean, -error:String, -imageLoading:Boolean, -imageError:Boolean | +handleTabClick(index,slug), +handleImageLoad(), +handleImageError() |
| ticketPricingApi | -api:AxiosInstance | +getTicketPricingAPI():Promise |

**Backend Layer:**

| Lớp | Phương thức |
|:----|:------------|
| TicketPricingController | +getTicketPricing(req,res), +updateTicketPricing(req,res), +getAllTicketPricing(req,res) |
| TicketPricingRoutes | GET / (Public), PUT / (Admin), GET /admin/all (Admin) |

**Model Layer:**

| Lớp | Thuộc tính | Ràng buộc |
|:----|:-----------|:----------|
| TicketPricing | title:String, tabs:[TicketPricingTab], notes:String, status:String | status ∈ {active,draft}, tabs.length ≥ 1, pre-save: single-active |
| TicketPricingTab | name:String, slug:String, imageUrl:String, sortOrder:Number | name required, slug required, imageUrl required |

Quan hệ:
•	TicketPricingPage «uses» ticketPricingApi (Dependency)
•	ticketPricingApi «HTTP» TicketPricingController (Dependency)
•	TicketPricingController «uses» TicketPricing Model (Dependency)
•	TicketPricing «contains» TicketPricingTab (Composition – embedded sub-document)
•	TicketPricingRoutes «uses» authMiddleware (Dependency – cho Admin routes)

Hình 3.xx. Sơ đồ Class Diagram rút gọn – Phân hệ Giá Vé

### 3.2.27.7. Thiết kế cơ sở dữ liệu – Collection ticketpricings

Bảng mô tả Collection ticketpricings:

| STT | Tên trường (Field) | Kiểu dữ liệu | Mô tả | Ràng buộc |
|:----|:-------------------|:-------------|:------|:----------|
| 1 | _id | ObjectId | Định danh bảng giá | PK |
| 2 | title | String | Tiêu đề bảng giá (VD: "Giá Vé rạp NMN Cinema - Hà Nội") | Required, trim, Default="Giá Vé rạp NMN Cinema - Hà Nội" |
| 3 | tabs | Array\<Object\> | Danh sách tab giá vé (embedded sub-document) | Required, min length 1 |
| 4 | tabs[].name | String | Tên hiển thị tab (VD: "GIÁ VÉ 2D") | Required, trim |
| 5 | tabs[].slug | String | Slug cho URL hash (VD: "2D-price") | Required, trim |
| 6 | tabs[].imageUrl | String | URL ảnh bảng giá chi tiết | Required |
| 7 | tabs[].sortOrder | Number | Thứ tự sắp xếp (số nhỏ hiển thị trước) | Default=0 |
| 8 | notes | String | Ghi chú bổ sung (HTML content) | Default="" |
| 9 | status | String | Trạng thái hiển thị | Enum: active/draft, Default="active", Indexed |
| 10 | createdAt | Date | Ngày tạo | Auto (timestamps) |
| 11 | updatedAt | Date | Ngày cập nhật | Auto (timestamps) |

Index & ràng buộc:
•	Index trên trường `status` để tối ưu truy vấn lấy bảng giá active.
•	Pre-save hook đảm bảo ràng buộc single-active:khi lưu bảng giá với status='active',tự động chuyển các bảng giá khác sang 'draft'.
•	Validator trên trường `tabs`:mảng phải có ít nhất 1 phần tử.

Thiết kế lựa chọn nhúng (embed) thay vì tham chiếu (reference):
•	Tabs được nhúng trực tiếp trong document TicketPricing thay vì tách thành collection riêng,vì tabs luôn được đọc cùng bảng giá và số lượng tabs nhỏ (thường 2-5 tabs),phù hợp với nguyên tắc data modeling của MongoDB "nhúng khi dữ liệu cần hiển thị cùng nhau thường xuyên".
