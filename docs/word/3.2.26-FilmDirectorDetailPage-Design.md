# 3.2.26. Thiết kế hệ thống – Chi tiết đạo diễn (FilmDirectorDetailPage)

## 3.2.26.1. Kiến trúc tổng thể phân hệ FilmDirectorDetailPage

Phân hệ FilmDirectorDetailPage được thiết kế theo mô hình kiến trúc web tách lớp, hiển thị thông tin chi tiết của một đạo diễn bao gồm thông tin cá nhân, tiểu sử, gallery ảnh và filmography.

**Mô hình kiến trúc và thành phần:**

**Frontend (ReactJS):**
- `FilmDirectorDetailPage.jsx`: Component chính hiển thị chi tiết đạo diễn.
- `personApi.js`: API client cho các endpoint person.
- State Management: useState, useEffect, useRef (view cooldown tracking).
- Features: Gallery lightbox với autoplay, filmography grid, breadcrumb.

**Backend (Node.js/Express):**
- `personController.js`: Controller xử lý các request.
- Endpoints chính:
  - `GET /api/v1/persons/:slug`: Lấy chi tiết đạo diễn theo slug
  - `POST /api/v1/persons/:id/view`: Tăng view count
  - `POST /api/v1/persons/:id/like`: Toggle like/unlike

**Database (MongoDB):**
- Collection `persons`: Lưu trữ thông tin đạo diễn.
- Collection `movies`: Lấy phim đang chiếu cho sidebar và filmography references.

**Hình 3.52. Sơ đồ kiến trúc tổng thể phân hệ FilmDirectorDetailPage**

---

## 3.2.26.2. Use Case Diagram – FilmDirectorDetailPage

**Mô tả:**
Use Case Diagram mô tả các chức năng chính của trang chi tiết đạo diễn và mối quan hệ giữa các tác nhân với hệ thống.

**Tác nhân:**
- Guest (Khách): Xem thông tin, gallery, filmography, tiểu sử.
- User (Thành viên): Tất cả quyền của Guest + thích/bỏ thích.

**Các Use Case:**
| UC ID | Tên Use Case | Tác nhân | Quan hệ |
|:------|:-------------|:---------|:--------|
| UC-DD-01 | Xem thông tin cá nhân đạo diễn | Guest, User | |
| UC-DD-02 | Xem tiểu sử | Guest, User | |
| UC-DD-03 | Xem thư viện hình ảnh | Guest, User | |
| UC-DD-04 | Mở lightbox xem ảnh phóng to | Guest, User | <<include>> từ UC-03 |
| UC-DD-05 | Điều khiển autoplay gallery | Guest, User | |
| UC-DD-06 | Xem filmography | Guest, User | |
| UC-DD-07 | Điều hướng đến chi tiết phim | Guest, User | <<extend>> từ UC-06 |
| UC-DD-08 | Thích đạo diễn | User | <<extend>> từ UC-01 |
| UC-DD-09 | Bỏ thích đạo diễn | User | <<extend>> từ UC-01 |
| UC-DD-10 | Tự động tăng view count | System | <<include>> từ UC-01 |

**Hình 3.53. Sơ đồ Use Case Diagram – FilmDirectorDetailPage**

```
PROMPT VẼ SƠ ĐỒ (Draw.io/PlantUML):
-----------------------------------
Vẽ Use Case Diagram với:
- Hệ thống: FilmDirectorDetailPage (hình chữ nhật bao quanh)
- 3 Actor: Guest (trái), User (trái, kế thừa Guest), System (phải)
- 10 Use Case (hình oval):
  1. Xem thông tin cá nhân đạo diễn (trung tâm)
  2. Xem tiểu sử
  3. Xem thư viện hình ảnh
  4. Mở lightbox xem ảnh phóng to
  5. Điều khiển autoplay gallery
  6. Xem filmography (phim đã đạo diễn)
  7. Điều hướng đến chi tiết phim
  8. Thích đạo diễn
  9. Bỏ thích đạo diễn
  10. Tự động tăng view count

Quan hệ:
- Guest nối đến UC 1-7
- User kế thừa Guest, nối thêm UC 8, 9
- System nối đến UC 10
- UC 4 <<include>> từ UC 3
- UC 7 <<extend>> từ UC 6
- UC 8, 9 <<extend>> từ UC 1
- UC 10 <<include>> từ UC 1
```

---

## 3.2.26.3. Activity Diagram – Luồng xem chi tiết và tăng view

**Mô tả:**
Activity Diagram mô tả luồng xử lý khi người dùng truy cập trang chi tiết đạo diễn, bao gồm cơ chế tăng view count với cooldown 24 giờ.

**Luồng xử lý chính:**
1. Người dùng truy cập `/dao-dien-chi-tiet/:slug`
2. Hiển thị loading spinner
3. Gọi song song 2 API:
   - GET /api/v1/persons/:slug
   - GET /api/v1/movies/now-showing
4. [Decision] Tìm thấy đạo diễn?
   - Không → Hiển thị trang 404 → Kết thúc
   - Có → Tiếp tục
5. Render thông tin đạo diễn (thông tin cá nhân, tiểu sử, gallery, filmography)
6. [Decision] Kiểm tra cooldown 24h trong localStorage
   - Đã xem trong 24h → Không tăng view → Bước 9
   - Chưa xem / hết cooldown → Tiếp tục
7. [Decision] Kiểm tra viewIncrementedRef (StrictMode guard)
   - Đã increment trong session → Không gọi API → Bước 9
   - Chưa increment → Tiếp tục
8. Tăng view count:
   - Set ref = true
   - Lưu timestamp vào localStorage
   - Optimistic update: +1 viewCount
   - Gọi API POST /persons/:id/view
   - Sync viewCount từ server
9. Hiển thị trang chi tiết hoàn chỉnh → Kết thúc

**Hình 3.54. Sơ đồ Activity Diagram – Luồng xem chi tiết đạo diễn**

```
PROMPT VẼ SƠ ĐỒ (Draw.io/PlantUML):
-----------------------------------
Vẽ Activity Diagram với 3 swimlanes: Frontend | localStorage | Backend API

Frontend:
[●] Start: Truy cập /dao-dien-chi-tiet/:slug
- Hiển thị loading spinner
- Gọi song song: getPersonBySlugAPI + getNowShowingMoviesAPI
[◇] Tìm thấy đạo diễn? (role = director/both)
  - Không: Hiển thị 404 "Không tìm thấy" → [◉] End
  - Có: tiếp
- Render thông tin đạo diễn

localStorage:
- Đọc director_view_{id}
- Tính diff = now - lastViewTime

Frontend:
[◇] diff <= 24h (86400000ms)?
  - Có: Bỏ qua tăng view → Tiếp đến "Hoàn thành"
  - Không: tiếp
[◇] viewIncrementedRef[id] = true?
  - Có: Bỏ qua → Tiếp đến "Hoàn thành"
  - Không: tiếp
- Set viewIncrementedRef[id] = true

localStorage:
- Lưu director_view_{id} = now

Frontend:
- Optimistic: setDirector(viewCount + 1)
- Gọi incrementPersonViewAPI(id)

Backend API:
- Person.findByIdAndUpdate($inc viewCount)
- Return { viewCount: serverCount }

Frontend:
- Sync viewCount từ response
- Hiển thị hoàn chỉnh → [◉] End
```

---

## 3.2.26.4. Sequence Diagram – View Count với Cooldown

**Mô tả:**
Sequence Diagram mô tả luồng tương tác chi tiết khi tăng view count với cơ chế cooldown 24 giờ và guard chống double-call trong React StrictMode.

**Participants:**
- Browser (Actor)
- FilmDirectorDetailPage (Frontend)
- viewIncrementedRef (useRef)
- localStorage (Browser Storage)
- personApi (API Client)
- PersonController (Backend)
- Person Model (MongoDB)

**Luồng xử lý chi tiết:**
1. Browser navigate đến `/dao-dien-chi-tiet/:slug`
2. useEffect[director._id] được trigger
3. Kiểm tra director._id có tồn tại
4. Đọc localStorage: `director_view_{id}`
5. Tính diff = Date.now() - lastViewTime
6. [alt] Nếu diff <= 86400000ms (24h)
   - Return (đã xem gần đây, không tăng view)
7. [alt] Nếu hết cooldown:
   - Kiểm tra viewIncrementedRef.current[id]
   - [alt] Nếu đã increment trong session → Return
   - [alt] Nếu chưa increment:
     a. Set viewIncrementedRef.current[id] = true
     b. Lưu localStorage: director_view_{id} = now
     c. Optimistic update: viewCount += 1
     d. Gọi incrementPersonViewAPI(id)
     e. Backend cập nhật MongoDB: $inc viewCount
     f. Backend trả về { viewCount: serverCount }
     g. Frontend sync viewCount từ server

**Hình 3.55. Sơ đồ Sequence Diagram – Tăng view count với cooldown**

```
PROMPT VẼ SƠ ĐỒ (Draw.io/PlantUML):
-----------------------------------
Vẽ Sequence Diagram với 7 participants:
Browser | FilmDirectorDetailPage | viewIncrementedRef | localStorage | personApi | PersonController | Person

Luồng message:
1. Browser -> FilmDirectorDetailPage: navigate /dao-dien-chi-tiet/:slug
2. FilmDirectorDetailPage -> FilmDirectorDetailPage: useEffect triggered (director._id)
3. FilmDirectorDetailPage -> localStorage: get director_view_{id}
4. localStorage --> FilmDirectorDetailPage: lastViewTime (number/null)
5. FilmDirectorDetailPage -> FilmDirectorDetailPage: calculate diff = now - lastViewTime

alt [diff <= 24h (86400000ms)]:
  6. Note over FilmDirectorDetailPage: "Đã xem gần đây, không tăng view"
  7. FilmDirectorDetailPage -> FilmDirectorDetailPage: return (no action)

alt [diff > 24h hoặc chưa xem]:
  8. FilmDirectorDetailPage -> viewIncrementedRef: check current[id]

  alt [đã increment trong session]:
    9. viewIncrementedRef --> FilmDirectorDetailPage: true
    10. Note over FilmDirectorDetailPage: "StrictMode guard - skip"
    11. FilmDirectorDetailPage -> FilmDirectorDetailPage: return

  alt [chưa increment]:
    12. viewIncrementedRef --> FilmDirectorDetailPage: false/undefined
    13. FilmDirectorDetailPage -> viewIncrementedRef: set current[id] = true
    14. FilmDirectorDetailPage -> localStorage: set director_view_{id} = now
    15. FilmDirectorDetailPage -> FilmDirectorDetailPage: setDirector(viewCount + 1) [Optimistic]
    16. FilmDirectorDetailPage -> personApi: incrementPersonViewAPI(id)
    17. personApi -> PersonController: POST /persons/:id/view
    18. PersonController -> Person: findByIdAndUpdate($inc viewCount)
    19. Person --> PersonController: updated document
    20. PersonController --> personApi: {success, data: {viewCount}}
    21. personApi --> FilmDirectorDetailPage: response
    22. FilmDirectorDetailPage -> FilmDirectorDetailPage: sync viewCount from server
```

---

## 3.2.26.5. Class Diagram rút gọn – FilmDirectorDetailPage

**Mục đích:**
Mô tả cấu trúc các lớp và mối quan hệ trong phân hệ FilmDirectorDetailPage.

**Phạm vi:**
- Frontend: FilmDirectorDetailPage component, personApi module, movieApi module
- Backend: PersonController, Person Model, Movie Model (references)

**Các lớp chính:**

| Layer | Lớp | Thuộc tính / Phương thức |
|:------|:----|:-------------------------|
| Frontend | FilmDirectorDetailPage | director{}, sidebarMovies[], loading, isLiked, likeLoading, openGallery, currentImageIndex, isAutoPlay, viewIncrementedRef, fetchSeqRef / fetchDirector(), incrementView(), handleToggleLike(), handleOpenGallery(), handleNextImage(), handlePrevImage(), handleMovieClick() |
| Frontend | personApi | getPersonBySlugAPI(), incrementPersonViewAPI(), togglePersonLikeAPI() |
| Frontend | movieApi | getNowShowingMoviesAPI() |
| Backend | PersonController | getPersonBySlug(), incrementPersonView(), togglePersonLike() |
| Database | Person | _id, name, slug, role, avatar, shortBio, fullBio, birthDate, height, nationality, birthPlace, occupation, gallery[], filmography[], viewCount, likeCount |
| Database | Movie | _id, title, slug, poster, rating (referenced trong filmography) |

**Quan hệ:**
- FilmDirectorDetailPage `-->` personApi: uses
- FilmDirectorDetailPage `-->` movieApi: uses
- personApi `-->` PersonController: HTTP
- PersonController `-->` Person: queries
- Person `-->` Movie: references (filmography)

**Hình 3.56. Sơ đồ Class Diagram rút gọn – FilmDirectorDetailPage**

```
PROMPT VẼ SƠ ĐỒ (Draw.io/PlantUML):
-----------------------------------
Vẽ Class Diagram với 2 layers: Frontend Layer và Backend Layer

Frontend Layer:
┌──────────────────────────────────────────┐
│ <<component>>                            │
│ FilmDirectorDetailPage                   │
├──────────────────────────────────────────┤
│ - director: Object                       │
│ - sidebarMovies: Array                   │
│ - loading: boolean                       │
│ - isLiked: boolean                       │
│ - likeLoading: boolean                   │
│ - openGallery: boolean                   │
│ - currentImageIndex: number              │
│ - isAutoPlay: boolean                    │
│ - viewIncrementedRef: useRef             │
│ - fetchSeqRef: useRef                    │
├──────────────────────────────────────────┤
│ + fetchDirector(): void                  │
│ + incrementView(): void                  │
│ + handleToggleLike(): void               │
│ + handleOpenGallery(index): void         │
│ + handleNextImage(): void                │
│ + handlePrevImage(): void                │
│ + handleMovieClick(slug): void           │
└──────────────────────────────────────────┘
         │ uses              │ uses
         ▼                   ▼
┌────────────────┐   ┌────────────────┐
│ <<module>>     │   │ <<module>>     │
│ personApi      │   │ movieApi       │
├────────────────┤   ├────────────────┤
│ +getPersonBy   │   │ +getNowShowing │
│  SlugAPI()     │   │  MoviesAPI()   │
│ +incrementPer  │   └────────────────┘
│  sonViewAPI()  │
│ +togglePerson  │
│  LikeAPI()     │
└────────────────┘
         │ HTTP
         ▼
Backend Layer:
┌─────────────────────────────────────────┐
│ <<controller>>                          │
│ PersonController                        │
├─────────────────────────────────────────┤
│ + getPersonBySlug(req, res): Response   │
│ + incrementPersonView(req, res): Resp   │
│ + togglePersonLike(req, res): Response  │
└─────────────────────────────────────────┘
         │ queries
         ▼
┌─────────────────────────────────────────┐
│ <<model>>                               │
│ Person                                  │
├─────────────────────────────────────────┤
│ _id: ObjectId                           │
│ name: string                            │
│ slug: string                            │
│ role: string                            │
│ avatar: string                          │
│ shortBio: string                        │
│ fullBio: string                         │
│ birthDate: Date                         │
│ height: number                          │
│ nationality: string                     │
│ birthPlace: string                      │
│ occupation: string                      │
│ gallery: Array<{url, caption}>          │
│ filmography: Array<{movie, role}>       │
│ viewCount: number                       │
│ likeCount: number                       │
├─────────────────────────────────────────┤
│                    │ references         │
└────────────────────│────────────────────┘
                     ▼
      ┌─────────────────────────────┐
      │ <<model>>                   │
      │ Movie                       │
      ├─────────────────────────────┤
      │ _id: ObjectId               │
      │ title: string               │
      │ slug: string                │
      │ poster: string              │
      │ rating: number              │
      └─────────────────────────────┘
```
