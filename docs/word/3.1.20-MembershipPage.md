## 3.1.20. Phân tích yêu cầu phân hệ 17: Thông tin Thành viên (MembershipPage)

### 3.1.20.1. Mục tiêu và phạm vi phân hệ

Phân hệ MembershipPage là trang hiển thị thông tin chương trình thành viên NMN Cinema, cung cấp chi tiết về thể lệ đăng ký, cách tích điểm, quyền lợi theo hạng thẻ, quà sinh nhật và quy định sử dụng điểm thưởng. Đây là chức năng công khai thông tin dịch vụ, giúp khách hàng hiểu rõ chương trình loyalty trước khi tham gia, đồng thời thúc đẩy tỷ lệ đăng ký thành viên tại rạp.

Phạm vi phân hệ bao gồm:
- Hiển thị tiêu đề trang thành viên từ API
- Hiển thị danh sách section nội dung (thể lệ, tích điểm, quà sinh nhật, sử dụng điểm)
- Mỗi section gồm: tiêu đề, ảnh banner minh họa (tùy chọn), nội dung HTML
- Sidebar thanh điều hướng nhanh (Quick Navigation) cho phép nhảy đến section bất kỳ
- Loading overlay toàn màn hình với logo NMN Cinema
- Xử lý lỗi API và lỗi tải ảnh với fallback message
- Chống hotlink ảnh bằng referrerPolicy="no-referrer"
- Sanitize HTML content từ Admin trước khi lưu vào database để chống XSS
- Quản trị viên có thể cập nhật nội dung thành viên thông qua API Admin
- Responsive layout cho desktop và mobile

### 3.1.20.2. Tác nhân và quyền hạn

| Tác nhân | Quyền hạn |
|:---------|:----------|
| Guest (khách) | Xem toàn bộ thông tin chương trình thành viên, điều hướng giữa các section |
| User (thành viên) | Tất cả quyền của Guest (trang thành viên là trang công khai, không phân biệt quyền) |
| Admin (quản trị) | Cập nhật/tạo mới nội dung thành viên, quản lý danh sách section, xem tất cả phiên bản nội dung (bao gồm bản nháp) |

### 3.1.20.3. Yêu cầu chức năng (FR) – MembershipPage

| ID | Yêu cầu | Mô tả | Ưu tiên |
|:---|:--------|:------|:--------|
| FR-MB-01 | Hiển thị tiêu đề trang | Render tiêu đề trang thành viên từ API (VD: "Chương trình Thành viên NMN Cinema Membership") | Cao |
| FR-MB-02 | Hiển thị danh sách section | Render danh sách section theo sortOrder, mỗi section gồm tiêu đề, ảnh banner (nếu có) và nội dung HTML | Cao |
| FR-MB-03 | Quick Navigation sidebar | Hiển thị thanh điều hướng bên phải liệt kê tất cả section, click để cuộn mượt đến section tương ứng | Cao |
| FR-MB-04 | Hiển thị ảnh banner | Hiển thị ảnh minh họa cho mỗi section (nếu có imageUrl), full width theo kích thước gốc | Trung bình |
| FR-MB-05 | Render nội dung HTML | Render nội dung HTML của section bằng dangerouslySetInnerHTML, áp dụng style wrapper thống nhất | Cao |
| FR-MB-06 | Loading state | Hiển thị loading overlay toàn màn hình với logo NMN Cinema khi tải dữ liệu | Cao |
| FR-MB-07 | Xử lý lỗi API | Hiển thị thông báo lỗi với nút "Thử lại" khi API không phản hồi | Cao |
| FR-MB-08 | Xử lý ảnh lỗi | Hiển thị fallback "Ảnh đang được cập nhật" khi ảnh banner không tải được | Cao |
| FR-MB-09 | Skeleton loading ảnh | Hiển thị skeleton animation khi ảnh đang tải, chuyển opacity mượt khi ảnh sẵn sàng | Trung bình |
| FR-MB-10 | Xử lý trạng thái trống | Hiển thị thông báo "Chưa có thông tin thành viên" khi API trả về 404 | Cao |
| FR-MB-11 | Sanitize HTML (Admin) | Backend sanitize HTML content trước khi lưu, loại bỏ inline style/class/script để đảm bảo giao diện đồng nhất và chống XSS | Cao |
| FR-MB-12 | Cập nhật nội dung (Admin) | API PUT cho phép Admin cập nhật tiêu đề, sections của trang thành viên | Cao |
| FR-MB-13 | Xem tất cả nội dung (Admin) | API GET cho Admin xem danh sách tất cả nội dung thành viên bao gồm bản nháp | Trung bình |

### 3.1.20.4. Yêu cầu phi chức năng (NFR)

| ID | Yêu cầu | Mô tả |
|:---|:--------|:------|
| NFR-MB-01 | Hiệu năng | Trang load < 3 giây, API response < 500ms, ảnh lazy load với skeleton |
| NFR-MB-02 | Responsive | Hỗ trợ desktop và mobile, sidebar ẩn trên màn hình nhỏ, nội dung full width trên mobile |
| NFR-MB-03 | Bảo mật | API Admin yêu cầu JWT + role admin, HTML content được sanitize trước khi lưu (chống XSS), chống hotlink ảnh bằng referrerPolicy |
| NFR-MB-04 | Tương thích | Hoạt động tốt trên Chrome, Firefox, Safari, Edge phiên bản mới nhất |
| NFR-MB-05 | Khả dụng | Có fallback cho mọi trạng thái: loading, lỗi API, lỗi ảnh, dữ liệu trống |
| NFR-MB-06 | Trải nghiệm | Cuộn mượt đến section khi click Quick Navigation, opacity transition 0.3s cho ảnh |
| NFR-MB-07 | Bảo toàn giao diện | Nội dung HTML từ Admin luôn được render đúng style nhờ CSS wrapper, không phụ thuộc inline style |

### 3.1.20.5. Quy tắc nghiệp vụ

- **BR-MB-01 (Chỉ hiển thị trang active):** Frontend gọi API GET lấy trang thành viên có status = 'active'. Hệ thống đảm bảo tại mọi thời điểm chỉ có tối đa 1 trang thành viên ở trạng thái active.

- **BR-MB-02 (Single-active enforcement):** Khi Admin lưu trang thành viên mới với status = 'active', pre-save hook tự động chuyển tất cả trang thành viên khác sang trạng thái 'draft' để đảm bảo ràng buộc single-active.

- **BR-MB-03 (Sections sắp xếp theo sortOrder):** Danh sách section được sắp xếp theo trường sortOrder tăng dần ở phía backend trước khi trả về cho frontend, đảm bảo thứ tự hiển thị nhất quán.

- **BR-MB-04 (Sanitize HTML trước lưu):** Mọi nội dung HTML trong trường content của section đều được sanitize bằng thư viện sanitize-html trước khi lưu vào database. Chỉ cho phép các tag semantic (p, h2-h4, ul, ol, li, strong, em, table, a, br, span). Loại bỏ inline style và class (trừ span với color hex) để frontend wrapper style kiểm soát toàn bộ giao diện.

- **BR-MB-05 (Frontend wrapper style):** Nội dung HTML từ database được render trong một Box wrapper có sẵn các quy tắc CSS cho heading, paragraph, list, table, strong. Điều này đảm bảo dù Admin nhập nội dung bất kỳ, giao diện vẫn luôn đồng nhất.

- **BR-MB-06 (Ảnh banner tùy chọn):** Không phải section nào cũng có ảnh banner. Trường imageUrl mặc định là chuỗi rỗng. Frontend chỉ render ảnh khi imageUrl có giá trị.

- **BR-MB-07 (Fallback ảnh):** Khi ảnh banner không tải được (lỗi hotlink, URL hết hạn), hệ thống hiển thị placeholder "Ảnh đang được cập nhật" thay vì để trống hoặc hiển thị icon broken image.

- **BR-MB-08 (Validate sections tối thiểu):** Khi Admin cập nhật nội dung thành viên, backend validate mảng sections phải có ít nhất 1 phần tử. Nếu không đạt, trả về lỗi 400.

---

*Phần phân tích yêu cầu trên đây là cơ sở để thiết kế kiến trúc hệ thống, sơ đồ Use Case, Activity Diagram, Sequence Diagram và Class Diagram trong mục 3.2 tiếp theo.*
