## 3.2.24. Thiết kế hệ thống – ActorDetailPage (Chi tiết diễn viên)

### 3.2.24.1. Kiến trúc tổng thể phân hệ ActorDetailPage

Phân hệ ActorDetailPage được thiết kế theo mô hình kiến trúc web tách lớp, hiển thị thông tin chi tiết của một diễn viên bao gồm thông tin cá nhân, tiểu sử, gallery ảnh và filmography.

**Mô hình kiến trúc và thành phần:**

- **Frontend (ReactJS):**
  - `ActorDetailPage.jsx`: Component chính hiển thị chi tiết diễn viên
  - `personApi.js`: API client cho các endpoint person
  - **State Management**: useState, useEffect, useRef (view cooldown tracking)
  - **Features**: Gallery lightbox với autoplay, filmography grid, breadcrumbs

- **Backend (Node.js/Express):**
  - `personController.js`: Controller xử lý các request
  - **Endpoints chính:**
    - `GET /api/v1/persons/:slug`: Lấy chi tiết diễn viên theo slug
    - `POST /api/v1/persons/:id/view`: Tăng view count
    - `POST /api/v1/persons/:id/like`: Toggle like/unlike

- **Database (MongoDB):**
  - Collection `persons`: Lưu trữ thông tin diễn viên
  - Collection `movies`: Lấy phim đang chiếu cho sidebar

**Sơ đồ:**
```
[Hình 3.x. Sơ đồ kiến trúc tổng thể phân hệ ActorDetailPage]
```

**Prompt vẽ sơ đồ kiến trúc:**
```
Vẽ sơ đồ kiến trúc 3 tầng cho phân hệ ActorDetailPage:
- Tầng 1 (Frontend): Box "ActorDetailPage.jsx" với states (actor, loading, openGallery, isLiked) + "personApi.js" + "localStorage" (view cooldown, like state)
- Tầng 2 (Backend): Box "personRoutes.js" → "personController" với 3 methods: getPersonBySlug, incrementPersonView, togglePersonLike
- Tầng 3 (Database): Box "MongoDB" với collection "persons" (chi tiết) + "movies" (sidebar)
- Mũi tên: Frontend ↔ Backend (HTTPS/REST API), Backend ↔ MongoDB (Mongoose Query)
```

---

### 3.2.24.2. Use Case Diagram – ActorDetailPage

**Mục đích:**
Sơ đồ Use Case mô tả các chức năng mà người dùng có thể thực hiện trên trang chi tiết diễn viên.

**Tác nhân tham gia:**
- **Guest**: Người dùng chưa đăng nhập
- **User**: Người dùng đã đăng nhập

**Danh sách Use Case:**

| Mã | Tên Use Case | Tác nhân | Mô tả |
|:---|:-------------|:---------|:------|
| UC-AD-01 | Xem thông tin cá nhân | Guest, User | Xem tên, ảnh, ngày sinh, quốc tịch, chiều cao, nghề nghiệp |
| UC-AD-02 | Xem tiểu sử | Guest, User | Xem shortBio và fullBio của diễn viên |
| UC-AD-03 | Xem gallery ảnh | Guest, User | Xem grid ảnh và click để mở lightbox |
| UC-AD-04 | Điều hướng gallery | Guest, User | Next/Prev ảnh trong lightbox, Play/Pause autoplay |
| UC-AD-05 | Xem filmography | Guest, User | Xem danh sách phim đã tham gia với vai diễn |
| UC-AD-06 | Điều hướng đến phim | Guest, User | Click vào phim trong filmography để xem chi tiết |
| UC-AD-07 | Thích diễn viên | User | Thích/bỏ thích diễn viên, optimistic update |
| UC-AD-08 | Xem lượt xem | Guest, User | Xem viewCount của diễn viên |
| UC-AD-09 | Xem sidebar phim đang chiếu | Guest, User | Xem 3 phim đang chiếu ở sidebar |

**Sơ đồ:**
```
[Hình 3.x. Sơ đồ Use Case Diagram – ActorDetailPage]
```

**Prompt vẽ Use Case Diagram:**
```
Vẽ Use Case Diagram cho ActorDetailPage:
- Actors: Guest (bên trái), User (bên trái, kế thừa Guest)
- System boundary: "ActorDetailPage"
- Use Cases (9 oval):
  1. UC-AD-01: Xem thông tin cá nhân
  2. UC-AD-02: Xem tiểu sử
  3. UC-AD-03: Xem gallery ảnh
  4. UC-AD-04: Điều hướng gallery (extends UC-03)
  5. UC-AD-05: Xem filmography
  6. UC-AD-06: Điều hướng đến phim (extends UC-05)
  7. UC-AD-07: Thích diễn viên (chỉ User)
  8. UC-AD-08: Xem lượt xem
  9. UC-AD-09: Xem sidebar phim đang chiếu
- Guest connect đến UC-01 đến UC-06, UC-08, UC-09
- User connect đến UC-07
```

---

### 3.2.24.3. Activity Diagram – Luồng xem chi tiết và tăng view

**Mục đích:**
Mô tả luồng xử lý khi người dùng truy cập trang chi tiết diễn viên, bao gồm cơ chế cooldown view 24 giờ.

**Thành phần tham gia:**
- User (Browser)
- ActorDetailPage (React)
- localStorage
- personApi
- Backend API
- MongoDB

**Mô tả luồng chính:**

1. **Bắt đầu**: User truy cập `/dien-vien-chi-tiet/:slug`
2. **Hiển thị loading**: Spinner toàn màn hình
3. **Gọi API**: `getPersonBySlugAPI(slug)`
4. **Kiểm tra kết quả**:
   - Nếu không tìm thấy → Hiển thị 404 với nút quay lại
   - Nếu thành công → Tiếp tục
5. **Kiểm tra view cooldown**:
   - Đọc `actor_view_{id}` từ localStorage
   - Nếu > 24h hoặc chưa có → Gọi `incrementPersonViewAPI(id)` + Lưu timestamp
   - Nếu < 24h → Bỏ qua (không tăng view)
6. **Gọi API sidebar**: `getNowShowingMoviesAPI(5)`
7. **Khởi tạo like state**: Đọc `actor_liked_{id}` từ localStorage
8. **Render giao diện**: Thông tin + Gallery + Filmography + Sidebar
9. **User action**: Mở gallery, Like, Click phim
10. **Kết thúc**

**Sơ đồ:**
```
[Hình 3.x. Sơ đồ Activity Diagram – Luồng xem chi tiết diễn viên]
```

**Prompt vẽ Activity Diagram:**
```
Vẽ Activity Diagram với swimlanes (User, Frontend, localStorage, Backend, MongoDB):
- Start → User truy cập /dien-vien-chi-tiet/:slug
- Frontend: Hiển thị loading
- Frontend → Backend: getPersonBySlugAPI(slug)
- Backend → MongoDB: findOne({slug})
- Decision: "Tìm thấy person?"
  - No → "Hiển thị 404" → End
  - Yes → Continue
- Frontend → localStorage: getItem("actor_view_{id}")
- Decision: "Đã view trong 24h?"
  - No → Frontend → Backend: incrementPersonViewAPI(id) + localStorage.setItem timestamp
  - Yes → Skip
- Fork:
  (1) Backend: Lấy phim đang chiếu
  (2) Frontend: Khởi tạo like state từ localStorage
- Join → "Render giao diện chi tiết"
- Decision: "User action?"
  - "Mở Gallery" → "Hiển thị Lightbox" → Loop
  - "Click Like" → Subprocess Toggle Like
  - "Click phim" → Navigate → End
- End
```

---

### 3.2.24.4. Sequence Diagram – Tăng View Count với Cooldown

**Mục đích:**
Mô tả chi tiết cơ chế tăng lượt xem với cooldown 24 giờ để tránh spam view.

**Thành phần tham gia:**
- User
- ActorDetailPage
- localStorage
- viewIncrementedRef
- personApi
- Backend
- MongoDB

**Mô tả luồng:**

1. User mở trang chi tiết diễn viên
2. ActorDetailPage kiểm tra `viewIncrementedRef.current[actorId]`
   - Nếu true → return (đã tăng trong session này)
3. Set `viewIncrementedRef.current[actorId] = true`
4. Đọc `localStorage.getItem("actor_view_{id}")` → `lastViewTime`
5. Tính `now - lastViewTime`
6. **Decision**: Nếu > 24h (86,400,000ms) hoặc không có lastViewTime:
   - Lưu `localStorage.setItem("actor_view_{id}", now)`
   - Gọi `incrementPersonViewAPI(actorId)`
   - Backend: `Person.findByIdAndUpdate(id, { $inc: { viewCount: 1 } })`
   - Cập nhật `actor.viewCount` từ response
7. Nếu < 24h → Bỏ qua, không gọi API

**Sơ đồ:**
```
[Hình 3.x. Sơ đồ Sequence Diagram – Tăng View Count với Cooldown]
```

**Prompt vẽ Sequence Diagram:**
```
Vẽ Sequence Diagram cho View Count Cooldown:

Participants: User, ActorDetailPage, viewIncrementedRef, localStorage, personApi, Backend, MongoDB

1. User → ActorDetailPage: mở trang chi tiết
2. ActorDetailPage → viewIncrementedRef: check viewIncrementedRef.current[id]
3. alt [Đã increment trong session]: return
4. ActorDetailPage → viewIncrementedRef: set viewIncrementedRef.current[id] = true
5. ActorDetailPage → localStorage: getItem("actor_view_{id}")
6. localStorage → ActorDetailPage: lastViewTime
7. ActorDetailPage → ActorDetailPage: tính now - lastViewTime

alt [> 24h hoặc null]:
  8. ActorDetailPage → localStorage: setItem("actor_view_{id}", now)
  9. ActorDetailPage → personApi: incrementPersonViewAPI(id)
  10. personApi → Backend: POST /persons/:id/view
  11. Backend → MongoDB: findByIdAndUpdate($inc: {viewCount: 1})
  12. MongoDB → Backend: updated person
  13. Backend → personApi: {success, data: {viewCount}}
  14. personApi → ActorDetailPage: response
  15. ActorDetailPage → ActorDetailPage: update actor.viewCount

alt [< 24h]:
  8. ActorDetailPage → ActorDetailPage: skip (không gọi API)
```

---

### 3.2.24.5. Class Diagram rút gọn – ActorDetailPage

**Mục đích:**
Mô tả cấu trúc các lớp và mối quan hệ trong phân hệ ActorDetailPage.

**Các lớp chính:**

**Frontend Layer:**
```
┌──────────────────────────────────────────┐
│          ActorDetailPage                 │
├──────────────────────────────────────────┤
│ - actor: Actor | null                    │
│ - loading: boolean                       │
│ - otherMovies: Movie[]                   │
│ - openGallery: boolean                   │
│ - currentImageIndex: number              │
│ - isAutoPlay: boolean                    │
│ - isLiked: boolean                       │
│ - viewIncrementedRef: Ref                │
│ - VIEW_COOLDOWN_MS: number = 86400000    │
├──────────────────────────────────────────┤
│ + fetchData(): Promise<void>             │
│ + handleToggleLike(): void               │
│ + handleOpenGallery(index): void         │
│ + handleNextImage(): void                │
│ + handlePrevImage(): void                │
│ + formatDate(dateString): string         │
│ + calculateAge(birthDate): number        │
└──────────────────────────────────────────┘
```

**Backend Layer:**
```
┌──────────────────────────────────────────┐
│         PersonController                 │
├──────────────────────────────────────────┤
│ + getPersonBySlug(req, res): void        │
│ + incrementPersonView(req, res): void    │
│ + togglePersonLike(req, res): void       │
└──────────────────────────────────────────┘
```

**Mối quan hệ:**
- ActorDetailPage **depends on** personApi
- personApi **calls** PersonController (via HTTP)
- PersonController **uses** Person model

**Sơ đồ:**
```
[Hình 3.x. Sơ đồ Class Diagram rút gọn – ActorDetailPage]
```

**Prompt vẽ Class Diagram:**
```
Vẽ Class Diagram với 2 package:

Package "Frontend":
- Class "ActorDetailPage" với:
  Attributes: actor, loading, otherMovies, openGallery, currentImageIndex, isAutoPlay, isLiked, viewIncrementedRef, VIEW_COOLDOWN_MS
  Methods: fetchData(), handleToggleLike(), handleOpenGallery(), handleNextImage(), handlePrevImage(), formatDate(), calculateAge()
- Class "personApi" với methods: getPersonBySlugAPI(), incrementPersonViewAPI(), togglePersonLikeAPI()
- ActorDetailPage -----uses-----> personApi

Package "Backend":
- Class "PersonController" với methods: getPersonBySlug(), incrementPersonView(), togglePersonLike()
- Class "Person" (entity model)
- PersonController -----uses-----> Person

Cross-package:
- personApi .....HTTP REST.....> PersonController
```

---

*Các sơ đồ trên cần được vẽ bằng công cụ như draw.io, Lucidchart hoặc PlantUML và chèn vào báo cáo Word tại các vị trí đã đánh dấu [Hình 3.x].*
