<mxfile host="app.diagrams.net">
  <diagram name="Sequence Diagram - BookingPage Rating" id="seq-booking-rating">
    <mxGraphModel dx="1434" dy="900" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1600" pageHeight="1200">
      <root>
        <mxCell id="0"/>
        <mxCell id="1" parent="0"/>

        <!-- Title -->
        <mxCell id="title" value="Hình 3.x. Sequence Diagram chức năng Đánh giá phim (BookingPage)" style="text;html=1;align=center;verticalAlign=middle;rounded=0;fontSize=18;fontStyle=1" parent="1" vertex="1">
          <mxGeometry x="450" y="20" width="700" height="40" as="geometry"/>
        </mxCell>

        <!-- ==================== LIFELINES ==================== -->
        <!-- User -->
        <mxCell id="user" value="User" style="shape=umlLifeline;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=1;collapsible=0;recursiveResize=0;outlineConnect=0;fillColor=#dae8fc;strokeColor=#6c8ebf;strokeWidth=2" parent="1" vertex="1">
          <mxGeometry x="100" y="100" width="100" height="950" as="geometry"/>
        </mxCell>
        <mxCell id="user-act" value="" style="html=1;points=[];perimeter=orthogonalPerimeter;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="user" vertex="1">
          <mxGeometry x="45" y="70" width="10" height="850" as="geometry"/>
        </mxCell>

        <!-- Frontend: BookingPage -->
        <mxCell id="frontend" value="BookingPage\n(React Component)" style="shape=umlLifeline;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=1;collapsible=0;recursiveResize=0;outlineConnect=0;fillColor=#d5e8d4;strokeColor=#82b366;strokeWidth=2" parent="1" vertex="1">
          <mxGeometry x="350" y="100" width="160" height="950" as="geometry"/>
        </mxCell>
        <mxCell id="frontend-act" value="" style="html=1;points=[];perimeter=orthogonalPerimeter;fillColor=#d5e8d4;strokeColor=#82b366;" parent="frontend" vertex="1">
          <mxGeometry x="75" y="70" width="10" height="850" as="geometry"/>
        </mxCell>

        <!-- API Module -->
        <mxCell id="api" value="movieApi\n(Axios Module)" style="shape=umlLifeline;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=1;collapsible=0;recursiveResize=0;outlineConnect=0;fillColor=#fff2cc;strokeColor=#d6b656;strokeWidth=2" parent="1" vertex="1">
          <mxGeometry x="600" y="100" width="140" height="950" as="geometry"/>
        </mxCell>
        <mxCell id="api-act" value="" style="html=1;points=[];perimeter=orthogonalPerimeter;fillColor=#fff2cc;strokeColor=#d6b656;" parent="api" vertex="1">
          <mxGeometry x="65" y="230" width="10" height="550" as="geometry"/>
        </mxCell>

        <!-- Backend Controller -->
        <mxCell id="backend" value="Backend API\n(MovieController)" style="shape=umlLifeline;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=1;collapsible=0;recursiveResize=0;outlineConnect=0;fillColor=#ffe6cc;strokeColor=#d79b00;strokeWidth=2" parent="1" vertex="1">
          <mxGeometry x="830" y="100" width="140" height="950" as="geometry"/>
        </mxCell>
        <mxCell id="backend-act" value="" style="html=1;points=[];perimeter=orthogonalPerimeter;fillColor=#ffe6cc;strokeColor=#d79b00;" parent="backend" vertex="1">
          <mxGeometry x="65" y="250" width="10" height="510" as="geometry"/>
        </mxCell>

        <!-- Database -->
        <mxCell id="db" value="MongoDB\n(Database)" style="shape=umlLifeline;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=1;collapsible=0;recursiveResize=0;outlineConnect=0;fillColor=#e1d5e7;strokeColor=#9673a6;strokeWidth=2" parent="1" vertex="1">
          <mxGeometry x="1060" y="100" width="120" height="950" as="geometry"/>
        </mxCell>
        <mxCell id="db-act" value="" style="html=1;points=[];perimeter=orthogonalPerimeter;fillColor=#e1d5e7;strokeColor=#9673a6;" parent="db" vertex="1">
          <mxGeometry x="55" y="550" width="10" height="150" as="geometry"/>
        </mxCell>

        <!-- ==================== MESSAGES ==================== -->

        <!-- 1. Click Đánh giá -->
        <mxCell id="msg1" value="1. Click &quot;Đánh giá&quot;" style="html=1;verticalAlign=bottom;endArrow=block;entryX=0;entryY=0;rounded=0;" parent="1" source="user-act" target="frontend-act" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="155" y="180" as="sourcePoint"/>
            <mxPoint x="420" y="180" as="targetPoint"/>
          </mxGeometry>
        </mxCell>

        <!-- 2. Show Modal -->
        <mxCell id="msg2" value="setOpenRatingModal(true)" style="html=1;verticalAlign=bottom;endArrow=classic;rounded=0;dashed=1;" parent="1" source="frontend-act" target="frontend-act" edge="1">
          <mxGeometry width="50" relative="1" as="geometry">
            <mxPoint x="435" y="190" as="sourcePoint"/>
            <mxPoint x="435" y="210" as="targetPoint"/>
            <Array as="points">
              <mxPoint x="480" y="190"/>
              <mxPoint x="480" y="210"/>
            </Array>
          </mxGeometry>
        </mxCell>

        <!-- 3. Chọn sao và submit -->
        <mxCell id="msg3" value="2. Chọn sao &amp; Click &quot;Xác nhận&quot;" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;" parent="1" source="user-act" target="frontend-act" edge="1">
          <mxGeometry x="-0.04" y="10" relative="1" as="geometry">
            <mxPoint x="155" y="230" as="sourcePoint"/>
            <mxPoint x="425" y="230" as="targetPoint"/>
            <mxPoint as="offset"/>
          </mxGeometry>
        </mxCell>

        <!-- ALT Fragment: Token Check -->
        <mxCell id="alt1" value="alt" style="shape=umlFrame;whiteSpace=wrap;html=1;pointerEvents=0;recursiveResize=0;container=1;collapsible=0;width=40;" parent="1" vertex="1">
          <mxGeometry x="60" y="260" width="1200" height="660" as="geometry"/>
        </mxCell>
        <mxCell id="alt1-title" value="Validation &amp; Process" style="text;html=1;align=center;" parent="alt1" vertex="1">
          <mxGeometry x="40" width="150" height="20" as="geometry"/>
        </mxCell>

        <!-- CASE 1: Chưa đăng nhập -->
        <mxCell id="case1" value="[Token missing]" style="text;html=1;align=left;fontStyle=1" parent="alt1" vertex="1">
          <mxGeometry x="50" y="30" width="120" height="20" as="geometry"/>
        </mxCell>

        <mxCell id="msg4" value="check localStorage" style="html=1;verticalAlign=bottom;endArrow=classic;rounded=0;" parent="alt1" source="frontend-act" target="frontend-act" edge="1">
          <mxGeometry width="50" relative="1" as="geometry">
            <mxPoint x="375" y="50" as="sourcePoint"/>
            <mxPoint x="375" y="70" as="targetPoint"/>
            <Array as="points">
              <mxPoint x="420" y="50"/>
              <mxPoint x="420" y="70"/>
            </Array>
          </mxGeometry>
        </mxCell>

        <mxCell id="msg5" value="Alert(&quot;Vui lòng đăng nhập!&quot;)" style="html=1;verticalAlign=bottom;endArrow=open;dashed=1;endSize=8;rounded=0;" parent="alt1" source="frontend-act" target="user-act" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="365" y="80" as="sourcePoint"/>
            <mxPoint x="95" y="80" as="targetPoint"/>
          </mxGeometry>
        </mxCell>

        <!-- SEPARATOR -->
        <mxCell id="sep1" value="[Token valid]" style="shape=line;html=1;dashPattern=5 5;strokeWidth=1;" parent="alt1" vertex="1">
          <mxGeometry x="0" y="100" width="1200" height="10" as="geometry"/>
        </mxCell>

        <!-- CASE 2: Đã đăng nhập -->
        <mxCell id="msg6" value="3. rateMovieAPI(movieId, rating)" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;" parent="alt1" source="frontend-act" target="api-act" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="375" y="130" as="sourcePoint"/>
            <mxPoint x="605" y="130" as="targetPoint"/>
          </mxGeometry>
        </mxCell>

        <mxCell id="msg7" value="4. POST /api/v1/movies/:id/rate" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;" parent="alt1" source="api-act" target="backend-act" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="615" y="150" as="sourcePoint"/>
            <mxPoint x="835" y="150" as="targetPoint"/>
          </mxGeometry>
        </mxCell>

        <mxCell id="note-token" value="Header: Bearer {token}" style="shape=note;whiteSpace=wrap;html=1;size=10;verticalAlign=middle;align=center;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="alt1" vertex="1">
          <mxGeometry x="680" y="110" width="110" height="30" as="geometry"/>
        </mxCell>

        <!-- NESTED ALT: Server Response -->
        <mxCell id="alt2" value="alt" style="shape=umlFrame;whiteSpace=wrap;html=1;pointerEvents=0;recursiveResize=0;container=1;collapsible=0;width=40;" parent="alt1" vertex="1">
          <mxGeometry x="450" y="180" width="700" height="460" as="geometry"/>
        </mxCell>
        <mxCell id="alt2-title" value="Server Logic" style="text;html=1;align=center;" parent="alt2" vertex="1">
          <mxGeometry x="40" width="100" height="20" as="geometry"/>
        </mxCell>

        <!-- Case 2A: 401 Unauthorized -->
        <mxCell id="case2a" value="[401 Unauthorized]" style="text;html=1;align=left;fontStyle=1" parent="alt2" vertex="1">
          <mxGeometry x="50" y="30" width="120" height="20" as="geometry"/>
        </mxCell>

        <mxCell id="msg8" value="401 Unauthorized" style="html=1;verticalAlign=bottom;endArrow=open;dashed=1;endSize=8;rounded=0;fontColor=#FF0000" parent="alt2" source="backend-act" target="api-act" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="385" y="50" as="sourcePoint"/>
            <mxPoint x="165" y="50" as="targetPoint"/>
          </mxGeometry>
        </mxCell>

        <mxCell id="sep2" value="[400 Bad Request]" style="shape=line;html=1;dashPattern=5 5;strokeWidth=1;align=left;labelPosition=left;verticalLabelPosition=middle;" parent="alt2" vertex="1">
          <mxGeometry x="0" y="80" width="700" height="10" as="geometry"/>
        </mxCell>
        <mxCell id="case2b" value="[400 Bad Request]" style="text;html=1;align=left;fontStyle=1;" parent="alt2" vertex="1">
          <mxGeometry x="50" y="85" width="120" height="20" as="geometry"/>
        </mxCell>

        <mxCell id="msg9" value="400 Bad Request (Validation)" style="html=1;verticalAlign=bottom;endArrow=open;dashed=1;endSize=8;rounded=0;fontColor=#FF0000" parent="alt2" source="backend-act" target="api-act" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="385" y="110" as="sourcePoint"/>
            <mxPoint x="165" y="110" as="targetPoint"/>
          </mxGeometry>
        </mxCell>

        <mxCell id="sep3" value="[Success (200 OK)]" style="shape=line;html=1;dashPattern=5 5;strokeWidth=1;" parent="alt2" vertex="1">
          <mxGeometry x="0" y="140" width="700" height="10" as="geometry"/>
        </mxCell>
        <mxCell id="case2c" value="[200 OK]" style="text;html=1;align=left;fontStyle=1" parent="alt2" vertex="1">
          <mxGeometry x="50" y="145" width="120" height="20" as="geometry"/>
        </mxCell>

        <!-- DB Interactions -->
        <mxCell id="msg10" value="5. findById(movieId)" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;" parent="alt2" source="backend-act" target="db-act" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="395" y="170" as="sourcePoint"/>
            <mxPoint x="605" y="170" as="targetPoint"/>
          </mxGeometry>
        </mxCell>

        <mxCell id="msg11" value="return movieDoc" style="html=1;verticalAlign=bottom;endArrow=open;dashed=1;endSize=8;rounded=0;" parent="alt2" source="db-act" target="backend-act" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="605" y="200" as="sourcePoint"/>
            <mxPoint x="395" y="200" as="targetPoint"/>
          </mxGeometry>
        </mxCell>

        <mxCell id="msg12" value="Calc new average rating" style="html=1;verticalAlign=bottom;endArrow=classic;rounded=0;" parent="alt2" source="backend-act" target="backend-act" edge="1">
          <mxGeometry width="50" relative="1" as="geometry">
            <mxPoint x="395" y="210" as="sourcePoint"/>
            <mxPoint x="395" y="230" as="targetPoint"/>
            <Array as="points">
              <mxPoint x="440" y="210"/>
              <mxPoint x="440" y="230"/>
            </Array>
          </mxGeometry>
        </mxCell>

        <mxCell id="msg13" value="6. findByIdAndUpdate(rating)" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;" parent="alt2" source="backend-act" target="db-act" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="395" y="250" as="sourcePoint"/>
            <mxPoint x="605" y="250" as="targetPoint"/>
          </mxGeometry>
        </mxCell>

        <mxCell id="msg14" value="return updatedMovie" style="html=1;verticalAlign=bottom;endArrow=open;dashed=1;endSize=8;rounded=0;" parent="alt2" source="db-act" target="backend-act" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="605" y="280" as="sourcePoint"/>
            <mxPoint x="395" y="280" as="targetPoint"/>
          </mxGeometry>
        </mxCell>

        <mxCell id="msg15" value="7. 200 OK {rating, ratingCount}" style="html=1;verticalAlign=bottom;endArrow=open;dashed=1;endSize=8;rounded=0;fontColor=#009900" parent="alt2" source="backend-act" target="api-act" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="385" y="310" as="sourcePoint"/>
            <mxPoint x="165" y="310" as="targetPoint"/>
          </mxGeometry>
        </mxCell>
        <!-- End Nested Alt -->

        <!-- Return to Client -->
        <mxCell id="msg16" value="Return JSON Data" style="html=1;verticalAlign=bottom;endArrow=open;dashed=1;endSize=8;rounded=0;" parent="alt1" source="api-act" target="frontend-act" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="605" y="520" as="sourcePoint"/>
            <mxPoint x="375" y="520" as="targetPoint"/>
          </mxGeometry>
        </mxCell>

        <mxCell id="msg17" value="8. setMovie(newRating)" style="html=1;verticalAlign=bottom;endArrow=classic;rounded=0;" parent="alt1" source="frontend-act" target="frontend-act" edge="1">
          <mxGeometry width="50" relative="1" as="geometry">
            <mxPoint x="375" y="540" as="sourcePoint"/>
            <mxPoint x="375" y="560" as="targetPoint"/>
            <Array as="points">
              <mxPoint x="420" y="540"/>
              <mxPoint x="420" y="560"/>
            </Array>
          </mxGeometry>
        </mxCell>

        <mxCell id="msg18" value="9. Alert(&quot;Thành công!&quot;)" style="html=1;verticalAlign=bottom;endArrow=open;dashed=1;endSize=8;rounded=0;" parent="alt1" source="frontend-act" target="user-act" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="375" y="590" as="sourcePoint"/>
            <mxPoint x="95" y="590" as="targetPoint"/>
          </mxGeometry>
        </mxCell>

        <mxCell id="msg19" value="setOpenRatingModal(false)" style="html=1;verticalAlign=bottom;endArrow=classic;rounded=0;dashed=1;" parent="alt1" source="frontend-act" target="frontend-act" edge="1">
          <mxGeometry width="50" relative="1" as="geometry">
            <mxPoint x="375" y="610" as="sourcePoint"/>
            <mxPoint x="375" y="630" as="targetPoint"/>
            <Array as="points">
              <mxPoint x="420" y="610"/>
              <mxPoint x="420" y="630"/>
            </Array>
          </mxGeometry>
        </mxCell>

      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
